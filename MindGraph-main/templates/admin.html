<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindGraph ç®¡ç†åå° | Admin Panel</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="stylesheet" href="/static/fonts/inter.css?v={{ version }}">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #1e293b;
        }

        /* Header */
        .header {
            background: white;
            padding: 1rem 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.5rem;
            color: #667eea;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .lang-toggle {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 20px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 13px;
            color: #667eea;
            transition: all 0.3s;
            font-weight: 600;
        }

        .lang-toggle:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: scale(1.05);
        }

        .lang-en { display: inline; }
        .lang-zh { display: none; }
        .lang-az { display: none; }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            background: white;
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .tab {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            background: transparent;
            border: none;
            font-size: 1rem;
            font-weight: 500;
            color: #64748b;
        }

        .tab:hover {
            background: #f1f5f9;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(102, 126, 234, 0.2);
        }

        .stat-card h3 {
            font-size: 0.875rem;
            color: #64748b;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
        }

        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            text-align: left;
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        th {
            background: #f8fafc;
            font-weight: 600;
            color: #475569;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        tr:hover {
            background: #f8fafc;
        }

        /* Buttons */
        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 8px;
            border: none;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            font-family: inherit;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-warning {
            background: #f59e0b;
            color: white;
        }
        
        .btn-warning:hover {
            background: #d97706;
        }

        .btn-secondary {
            background: #64748b;
            color: white;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.8125rem;
        }

        /* Form */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #475569;
            margin-bottom: 0.5rem;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.3s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 120px;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content.chart-modal {
            max-width: 900px;
            width: 95%;
        }

        .chart-container {
            position: relative;
            height: 500px;
            margin-top: 1.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            background: #f8fafc;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .close {
            font-size: 1.5rem;
            cursor: pointer;
            color: #64748b;
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        /* Alert */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border-left: 4px solid #f59e0b;
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Grid Layout */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        /* Category Collapsible Sections */
        .category-content {
            padding: 1.5rem;
            display: block;
        }
        
        .category-content.collapsed {
            display: none;
        }

        /* Log Viewer */
        .log-viewer {
            height: 600px;
            overflow-y: auto;
            background: #1e293b;
            color: #e2e8f0;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            padding: 1rem;
        }
        
        .log-line {
            margin-bottom: 0.25rem;
            padding: 0.25rem 0;
            border-bottom: 1px solid #334155;
        }
        
        .log-timestamp {
            color: #94a3b8;
            margin-right: 0.5rem;
        }
        
        .log-level {
            font-weight: 600;
            margin-right: 0.5rem;
            padding: 0.125rem 0.375rem;
            border-radius: 3px;
            font-size: 0.75rem;
        }
        
        .log-level-debug { background: #64748b; color: white; }
        .log-level-info { background: #0ea5e9; color: white; }
        .log-level-warning { background: #f59e0b; color: white; }
        .log-level-error { background: #ef4444; color: white; }
        .log-level-critical { background: #dc2626; color: white; }
        
        .log-module {
            color: #a78bfa;
            margin-right: 0.5rem;
            font-weight: 500;
        }
        
        .log-message {
            color: #e2e8f0;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: 0.3s;
            border-radius: 28px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle-switch input:checked + .toggle-slider {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* Rich Text Editor */
        .rich-text-toolbar {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 8px 12px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            flex-wrap: wrap;
        }

        .toolbar-select {
            padding: 4px 8px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            background: white;
            font-size: 13px;
            cursor: pointer;
            min-width: 80px;
        }

        .toolbar-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .toolbar-btn:hover {
            background: #e2e8f0;
            border-color: #667eea;
        }

        .toolbar-btn:active {
            background: #cbd5e1;
        }

        .toolbar-divider {
            width: 1px;
            height: 24px;
            background: #e2e8f0;
            margin: 0 4px;
        }

        .toolbar-color {
            width: 32px;
            height: 32px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            padding: 2px;
            cursor: pointer;
            background: white;
        }

        .rich-text-editor {
            min-height: 150px;
            max-height: 400px;
            overflow-y: auto;
            padding: 16px;
            border: 1px solid #e2e8f0;
            border-radius: 0 0 8px 8px;
            background: white;
            font-size: 15px;
            line-height: 1.6;
            outline: none;
        }

        .rich-text-editor:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .rich-text-editor:empty:before {
            content: attr(data-placeholder);
            color: #94a3b8;
            pointer-events: none;
        }

        .rich-text-editor ul, .rich-text-editor ol {
            margin-left: 20px;
            padding-left: 0;
        }

        .rich-text-editor li {
            margin-bottom: 4px;
        }

        .rich-text-editor img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 8px 0;
        }

        /* Emoji Picker */
        .emoji-picker-wrapper {
            position: relative;
            display: inline-block;
        }

        .emoji-picker {
            position: absolute;
            bottom: 40px;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            width: 260px;
        }

        .emoji-tabs {
            display: flex;
            gap: 2px;
            margin-bottom: 8px;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 6px;
        }

        .emoji-tab {
            flex: 1;
            padding: 4px 6px;
            font-size: 11px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 4px;
            color: #64748b;
            transition: all 0.2s;
        }

        .emoji-tab:hover {
            background: #f1f5f9;
            color: #334155;
        }

        .emoji-tab.active {
            background: #e0f2fe;
            color: #0369a1;
            font-weight: 500;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 2px;
            max-height: 200px;
            overflow-y: auto;
        }

        .emoji-grid span {
            font-size: 20px;
            padding: 6px;
            cursor: pointer;
            border-radius: 4px;
            text-align: center;
            transition: background 0.2s;
        }

        .emoji-grid span:hover {
            background: #f1f5f9;
        }

        /* Danger Button */
        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div style="display:flex;align-items:center;gap:1rem;">
                <h1>ğŸ“ MindGraph <span class="lang-zh">ç®¡ç†åå°</span><span class="lang-en">Admin Panel</span><span class="lang-az">Ä°darÉ™ Paneli</span></h1>
                <button class="lang-toggle" onclick="toggleLanguage()" id="langToggle">
                    <span class="lang-en">ä¸­æ–‡</span>
                    <span class="lang-zh">AZ</span>
                    <span class="lang-az">EN</span>
                </button>
            </div>
            <div class="user-info">
                <span id="adminName">Admin</span>
                <button class="btn btn-secondary btn-sm" onclick="window.location.href='/editor'">
                    <span class="lang-zh">å›¾åº“</span>
                    <span class="lang-en">Gallery</span>
                    <span class="lang-az">Qalereya</span>
                </button>
                <button class="btn btn-secondary btn-sm" onclick="logout()">
                    <span class="lang-zh">ç™»å‡º</span>
                    <span class="lang-en">Logout</span>
                    <span class="lang-az">Ã‡Ä±xÄ±ÅŸ</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Alert -->
        <div id="alert" class="alert"></div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="dashboard" onclick="switchTab('dashboard', this)"><span class="lang-zh">ä»ªè¡¨ç›˜</span><span class="lang-en">Dashboard</span><span class="lang-az">Ä°darÉ™ Paneli</span></button>
            <button class="tab" data-tab="tokens" onclick="switchTab('tokens', this)"><span class="lang-zh">Tokenç»Ÿè®¡</span><span class="lang-en">Tokens</span><span class="lang-az">Tokenlar</span></button>
            <button class="tab" data-tab="schools" onclick="switchTab('schools', this)"><span class="lang-zh">å­¦æ ¡ç®¡ç†</span><span class="lang-en">Schools</span><span class="lang-az">MÉ™ktÉ™blÉ™r</span></button>
            <button class="tab" data-tab="users" onclick="switchTab('users', this)"><span class="lang-zh">ç”¨æˆ·ç®¡ç†</span><span class="lang-en">Users</span><span class="lang-az">Ä°stifadÉ™Ã§ilÉ™r</span></button>
            <button class="tab" data-tab="apikeys" onclick="switchTab('apikeys', this)"><span class="lang-zh">APIå¯†é’¥</span><span class="lang-en">API Keys</span><span class="lang-az">API AÃ§arlarÄ±</span></button>
            <button class="tab" data-tab="announcement" onclick="switchTab('announcement', this)"><span class="lang-zh">æ›´æ–°å…¬å‘Š</span><span class="lang-en">Announcement</span><span class="lang-az">Elan</span></button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card" data-metric="users" onclick="showTrendChart('users', this)">
                    <h3><span class="lang-zh">æ€»ç”¨æˆ·æ•°</span><span class="lang-en">Total Users</span><span class="lang-az">Ãœmumi Ä°stifadÉ™Ã§ilÉ™r</span></h3>
                    <div class="value" id="stat-users">-</div>
                </div>
                <div class="stat-card" data-metric="organizations" onclick="showTrendChart('organizations', this)">
                    <h3><span class="lang-zh">å­¦æ ¡æ•°é‡</span><span class="lang-en">Organizations</span><span class="lang-az">TÉ™ÅŸkilatlar</span></h3>
                    <div class="value" id="stat-orgs">-</div>
                </div>
                <div class="stat-card" data-metric="registrations" onclick="showTrendChart('registrations', this)">
                    <h3><span class="lang-zh">ä»Šæ—¥æ³¨å†Œ</span><span class="lang-en">Today</span><span class="lang-az">Bu GÃ¼n</span></h3>
                    <div class="value" id="stat-recent">-</div>
                </div>
                <div class="stat-card" data-metric="tokens" onclick="showTrendChart('tokens', this)">
                    <h3><span class="lang-zh">æ€»Tokenä½¿ç”¨</span><span class="lang-en">Total Tokens</span><span class="lang-az">Ãœmumi Tokenlar</span></h3>
                    <div class="value" id="stat-tokens">-</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">ğŸ† <span class="lang-zh">æ´»è·ƒå­¦æ ¡æ’è¡Œæ¦œ (æŒ‰æ€»Tokenä½¿ç”¨é‡)</span><span class="lang-en">Top Active Schools (by Total Tokens)</span><span class="lang-az">Æn Aktiv MÉ™ktÉ™blÉ™r (Ãœmumi TokenlÉ™rÉ™ GÃ¶rÉ™)</span></h2>
                </div>
                <div id="org-distribution"></div>
            </div>
        </div>

        <!-- Tokens Tracking Tab -->
        <div id="tokens-tab" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card" data-metric="token-today" onclick="showTrendChart('token-today', this)">
                    <h3><span class="lang-zh">ä»Šæ—¥Token</span><span class="lang-en">Today</span><span class="lang-az">Bu GÃ¼n</span></h3>
                    <div class="value" id="token-today">-</div>
                </div>
                <div class="stat-card" data-metric="token-week" onclick="showTrendChart('token-week', this)">
                    <h3><span class="lang-zh">è¿‡å»ä¸€å‘¨</span><span class="lang-en">Past Week</span><span class="lang-az">KeÃ§É™n HÉ™ftÉ™</span></h3>
                    <div class="value" id="token-week">-</div>
                </div>
                <div class="stat-card" data-metric="token-month" onclick="showTrendChart('token-month', this)">
                    <h3><span class="lang-zh">è¿‡å»ä¸€æœˆ</span><span class="lang-en">Past Month</span><span class="lang-az">KeÃ§É™n Ay</span></h3>
                    <div class="value" id="token-month">-</div>
                </div>
                <div class="stat-card" data-metric="token-total" onclick="showTrendChart('token-total', this)">
                    <h3><span class="lang-zh">æ€»è®¡</span><span class="lang-en">Total</span><span class="lang-az">Ãœmumi</span></h3>
                    <div class="value" id="token-total">-</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">ğŸ† <span class="lang-zh">ç”¨æˆ·Tokenæ’è¡Œæ¦œ(æŒ‰æ€»Tokenä½¿ç”¨é‡)</span><span class="lang-en">User Token Leaderboard (by Total Token Usage)</span><span class="lang-az">Ä°stifadÉ™Ã§i Token Reytinqi (Ãœmumi Token Ä°stifadÉ™sinÉ™ GÃ¶rÉ™)</span></h2>
                </div>
                <div id="token-users-list"></div>
            </div>
        </div>

        <!-- Schools Tab -->
        <div id="schools-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><span class="lang-zh">å­¦æ ¡åˆ—è¡¨</span><span class="lang-en">School List</span><span class="lang-az">MÉ™ktÉ™b SiyahÄ±sÄ±</span></h2>
                    <button class="btn btn-primary" onclick="showCreateSchoolModal()">
                        â• <span class="lang-zh">åˆ›å»ºå­¦æ ¡</span><span class="lang-en">Create School</span><span class="lang-az">MÉ™ktÉ™b Yarat</span>
                    </button>
                </div>
                <div id="schools-loading" class="spinner"></div>
                <table id="schools-table" style="display:none;">
                    <thead>
                        <tr>
                            <th><span class="lang-zh">å­¦æ ¡åç§°</span><span class="lang-en">Name</span><span class="lang-az">Ad</span></th>
                            <th><span class="lang-zh">é‚€è¯·ç </span><span class="lang-en">Invitation Code</span><span class="lang-az">DÉ™vÉ™t Kodu</span></th>
                            <th><span class="lang-zh">Tokenä½¿ç”¨é‡</span><span class="lang-en">Tokens Used</span><span class="lang-az">Ä°stifadÉ™ Olunan Tokenlar</span></th>
                            <th><span class="lang-zh">çŠ¶æ€</span><span class="lang-en">Status</span><span class="lang-az">Status</span></th>
                            <th><span class="lang-zh">ç”¨æˆ·æ•°</span><span class="lang-en">Users</span><span class="lang-az">Ä°stifadÉ™Ã§ilÉ™r</span></th>
                            <th><span class="lang-zh">æ“ä½œ</span><span class="lang-en">Actions</span><span class="lang-az">ÆmÉ™liyyatlar</span></th>
                        </tr>
                    </thead>
                    <tbody id="schools-tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- Users Tab -->
        <div id="users-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><span class="lang-zh">ç”¨æˆ·åˆ—è¡¨</span><span class="lang-en">User List</span><span class="lang-az">Ä°stifadÉ™Ã§i SiyahÄ±sÄ±</span></h2>
                </div>
                
                <!-- Filter Controls -->
                <div style="padding:1rem;background:#f8fafc;border-bottom:1px solid #e2e8f0;">
                    <div style="display:flex;gap:1rem;flex-wrap:wrap;align-items:end;">
                        <div style="flex:1;min-width:200px;">
                            <label class="form-label" style="margin-bottom:0.25rem;" for="user-search"><span class="lang-zh">æœç´¢</span><span class="lang-en">Search</span><span class="lang-az">Axtar</span></label>
                            <input type="text" id="user-search" name="user-search" class="form-input" 
                                   placeholder="Name or Phone" 
                                   autocomplete="off"
                                   onkeyup="if(event.key==='Enter') filterUsers()">
                        </div>
                        <div style="min-width:200px;">
                            <label class="form-label" style="margin-bottom:0.25rem;" for="user-org-filter"><span class="lang-zh">å­¦æ ¡ç­›é€‰</span><span class="lang-en">Filter by School</span><span class="lang-az">MÉ™ktÉ™bÉ™ GÃ¶rÉ™ Filtr</span></label>
                            <select id="user-org-filter" name="user-org-filter" class="form-select" onchange="filterUsers()">
                                <option value=""><span class="lang-zh">å…¨éƒ¨å­¦æ ¡</span><span class="lang-en">All Schools</span><span class="lang-az">BÃ¼tÃ¼n MÉ™ktÉ™blÉ™r</span></option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="filterUsers()">
                            ğŸ” <span class="lang-zh">æœç´¢</span><span class="lang-en">Search</span><span class="lang-az">Axtar</span>
                        </button>
                        <button class="btn btn-secondary" onclick="clearUserFilters()">
                            â†» <span class="lang-zh">é‡ç½®</span><span class="lang-en">Reset</span><span class="lang-az">SÄ±fÄ±rla</span>
                        </button>
                    </div>
                </div>

                <div id="users-loading" class="spinner"></div>
                <table id="users-table" style="display:none;">
                    <thead>
                        <tr>
                            <th><span class="lang-zh">æ‰‹æœºå·</span><span class="lang-en">Phone</span><span class="lang-az">Telefon</span></th>
                            <th><span class="lang-zh">å§“å</span><span class="lang-en">Name</span><span class="lang-az">Ad</span></th>
                            <th><span class="lang-zh">å­¦æ ¡</span><span class="lang-en">Organization</span><span class="lang-az">TÉ™ÅŸkilat</span></th>
                            <th><span class="lang-zh">Tokenä½¿ç”¨é‡</span><span class="lang-en">Tokens Used</span><span class="lang-az">Ä°stifadÉ™ Olunan Tokenlar</span></th>
                            <th><span class="lang-zh">æ³¨å†Œæ—¶é—´</span><span class="lang-en">Registration Time</span><span class="lang-az">Qeydiyyat VaxtÄ±</span></th>
                            <th><span class="lang-zh">æ“ä½œ</span><span class="lang-en">Actions</span><span class="lang-az">ÆmÉ™liyyatlar</span></th>
                        </tr>
                    </thead>
                    <tbody id="users-tbody"></tbody>
                </table>
                
                <!-- Pagination Controls -->
                <div id="users-pagination" style="display:none;padding:1rem;border-top:1px solid #e2e8f0;background:#f8fafc;">
                    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem;">
                        <div id="users-page-info" style="color:#64748b;">
                            <!-- Page info will be inserted here -->
                        </div>
                        <div style="display:flex;gap:0.5rem;">
                            <button id="users-prev-btn" class="btn btn-secondary btn-sm" onclick="previousUsersPage()">
                                â† <span class="lang-zh">ä¸Šä¸€é¡µ</span><span class="lang-en">Previous</span><span class="lang-az">ÆvvÉ™lki</span>
                            </button>
                            <div id="users-page-numbers" style="display:flex;gap:0.25rem;">
                                <!-- Page numbers will be inserted here -->
                            </div>
                            <button id="users-next-btn" class="btn btn-secondary btn-sm" onclick="nextUsersPage()">
                                <span class="lang-zh">ä¸‹ä¸€é¡µ</span><span class="lang-en">Next</span><span class="lang-az">NÃ¶vbÉ™ti</span> â†’
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- API Keys Tab -->
        <div id="apikeys-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">ğŸ”‘ <span class="lang-zh">APIå¯†é’¥ç®¡ç†</span><span class="lang-en">API Keys Management</span><span class="lang-az">API AÃ§arlarÄ± Ä°darÉ™etmÉ™si</span></h2>
                    <button class="btn btn-primary" onclick="showCreateAPIKeyModal()">
                        â• <span class="lang-zh">åˆ›å»ºå¯†é’¥</span><span class="lang-en">Create API Key</span><span class="lang-az">API AÃ§arÄ± Yarat</span>
                    </button>
                </div>
                <div id="apikeys-loading" class="spinner"></div>
                <table id="apikeys-table" style="display:none;">
                    <thead>
                        <tr>
                            <th><span class="lang-zh">åç§°</span><span class="lang-en">Name</span><span class="lang-az">Ad</span></th>
                            <th><span class="lang-zh">APIå¯†é’¥</span><span class="lang-en">API Key</span><span class="lang-az">API AÃ§arÄ±</span></th>
                            <th><span class="lang-zh">ä½¿ç”¨é‡</span><span class="lang-en">Usage</span><span class="lang-az">Ä°stifadÉ™</span></th>
                            <th><span class="lang-zh">çŠ¶æ€</span><span class="lang-en">Status</span><span class="lang-az">Status</span></th>
                            <th><span class="lang-zh">åˆ›å»ºæ—¶é—´</span><span class="lang-en">Created</span><span class="lang-az">YaradÄ±lÄ±b</span></th>
                            <th><span class="lang-zh">æœ€åä½¿ç”¨</span><span class="lang-en">Last Used</span><span class="lang-az">Son Ä°stifadÉ™</span></th>
                            <th><span class="lang-zh">æ“ä½œ</span><span class="lang-en">Actions</span><span class="lang-az">ÆmÉ™liyyatlar</span></th>
                        </tr>
                    </thead>
                    <tbody id="apikeys-tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- Update Announcement Tab -->
        <div id="announcement-tab" class="tab-content">
            <div id="announcement-loading" class="spinner"></div>
            
            <div id="announcement-form" style="display:none;">
                <!-- Enable/Disable Toggle -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title" style="font-size:1.1rem;"><span class="lang-zh">å…¬å‘Šå¼€å…³</span><span class="lang-en">Announcement Toggle</span><span class="lang-az">Elan AÃ§Ä±b-BaÄŸlama</span></h3>
                    </div>
                    <div style="padding:1rem;">
                        <div class="form-group" style="display:flex;align-items:center;gap:1rem;">
                            <label class="toggle-switch">
                                <input type="checkbox" id="announcement-enabled" name="announcement-enabled">
                                <span class="toggle-slider"></span>
                            </label>
                            <span style="font-weight:500;"><span class="lang-zh">å¯ç”¨æ›´æ–°å…¬å‘Š</span><span class="lang-en">Enable Update Announcement</span><span class="lang-az">YenilÉ™mÉ™ ElanÄ±nÄ± AktivlÉ™ÅŸdir</span></span>
                        </div>
                        <div style="margin-top:0.5rem;color:#64748b;font-size:0.875rem;">
                            <span class="lang-zh">å¼€å¯åï¼Œç”¨æˆ·ç™»å½•æ—¶å°†çœ‹åˆ°å…¬å‘Šå¼¹çª—ï¼ˆæ¯ä¸ªç‰ˆæœ¬åªæ˜¾ç¤ºä¸€æ¬¡ï¼‰</span><span class="lang-en">When enabled, users will see announcement popup on login (once per version)</span><span class="lang-az">AktivlÉ™ÅŸdirildikdÉ™, istifadÉ™Ã§ilÉ™r giriÅŸ zamanÄ± elan pÉ™ncÉ™rÉ™si gÃ¶rÉ™cÉ™klÉ™r (hÉ™r versiya Ã¼Ã§Ã¼n bir dÉ™fÉ™)</span>
                        </div>
                    </div>
                </div>

                <!-- Version -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title" style="font-size:1.1rem;"><span class="lang-zh">ç‰ˆæœ¬å·</span><span class="lang-en">Version Number</span><span class="lang-az">Versiya NÃ¶mrÉ™si</span></h3>
                    </div>
                    <div style="padding:1rem;">
                        <div class="form-group">
                            <label class="form-label" for="announcement-version"><span class="lang-zh">ç‰ˆæœ¬å·</span><span class="lang-en">Version Number</span><span class="lang-az">Versiya NÃ¶mrÉ™si</span></label>
                            <input type="text" id="announcement-version" name="announcement-version" class="form-input" placeholder="ä¾‹å¦‚: 1.5.0 / Example: 1.5.0 / MÉ™sÉ™lÉ™n: 1.5.0" autocomplete="off">
                            <small style="color:#64748b;"><span class="lang-zh">æ¯ä¸ªç‰ˆæœ¬å·åªä¼šæ˜¾ç¤ºä¸€æ¬¡å…¬å‘Šã€‚æ›´æ”¹ç‰ˆæœ¬å·åï¼Œæ‰€æœ‰ç”¨æˆ·å°†å†æ¬¡çœ‹åˆ°å…¬å‘Šã€‚</span><span class="lang-en">Each version number will only show announcement once. After changing version number, all users will see the announcement again.</span><span class="lang-az">HÉ™r versiya nÃ¶mrÉ™si yalnÄ±z bir dÉ™fÉ™ elan gÃ¶stÉ™rÉ™cÉ™k. Versiya nÃ¶mrÉ™sini dÉ™yiÅŸdikdÉ™n sonra, bÃ¼tÃ¼n istifadÉ™Ã§ilÉ™r yenidÉ™n elanÄ± gÃ¶rÉ™cÉ™klÉ™r.</span></small>
                        </div>
                    </div>
                </div>

                <!-- Content -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title" style="font-size:1.1rem;"><span class="lang-zh">å…¬å‘Šå†…å®¹</span><span class="lang-en">Announcement Content</span><span class="lang-az">Elan MÉ™zmunu</span></h3>
                    </div>
                    <div style="padding:1rem;">
                        <div class="form-group">
                            <label class="form-label" for="announcement-title"><span class="lang-zh">æ ‡é¢˜</span><span class="lang-en">Title</span><span class="lang-az">BaÅŸlÄ±q</span></label>
                            <input type="text" id="announcement-title" name="announcement-title" class="form-input" placeholder="ä¾‹å¦‚: ç³»ç»Ÿæ›´æ–° / Example: System Update / MÉ™sÉ™lÉ™n: Sistem YenilÉ™mÉ™si" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label class="form-label"><span class="lang-zh">å…¬å‘Šæ­£æ–‡</span><span class="lang-en">Announcement Body</span><span class="lang-az">Elan MÉ™tni</span></label>
                            <!-- Rich Text Toolbar -->
                            <div class="rich-text-toolbar">
                                <select id="font-family-zh" class="toolbar-select" onchange="announcementEditor.execCommand('fontName', this.value)" title="å­—ä½“">
                                    <option value="">å­—ä½“</option>
                                    <option value="Microsoft YaHei">å¾®è½¯é›…é»‘</option>
                                    <option value="SimSun">å®‹ä½“</option>
                                    <option value="SimHei">é»‘ä½“</option>
                                    <option value="KaiTi">æ¥·ä½“</option>
                                    <option value="FangSong">ä»¿å®‹</option>
                                    <option value="Arial">Arial</option>
                                </select>
                                <select id="font-size-zh" class="toolbar-select" onchange="announcementEditor.execCommand('fontSize', this.value)" title="å­—å·">
                                    <option value="">å­—å·</option>
                                    <option value="1">12px</option>
                                    <option value="2">14px</option>
                                    <option value="3">16px</option>
                                    <option value="4">18px</option>
                                    <option value="5">24px</option>
                                    <option value="6">32px</option>
                                    <option value="7">48px</option>
                                </select>
                                <div class="toolbar-divider"></div>
                                <button type="button" class="toolbar-btn" onclick="announcementEditor.execCommand('bold')" title="ç²—ä½“"><b>B</b></button>
                                <button type="button" class="toolbar-btn" onclick="announcementEditor.execCommand('italic')" title="æ–œä½“"><i>I</i></button>
                                <button type="button" class="toolbar-btn" onclick="announcementEditor.execCommand('underline')" title="ä¸‹åˆ’çº¿"><u>U</u></button>
                                <div class="toolbar-divider"></div>
                                <button type="button" class="toolbar-btn" onclick="announcementEditor.execCommand('insertUnorderedList')" title="æ— åºåˆ—è¡¨">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="8" y1="6" x2="21" y2="6"></line>
                                        <line x1="8" y1="12" x2="21" y2="12"></line>
                                        <line x1="8" y1="18" x2="21" y2="18"></line>
                                        <circle cx="4" cy="6" r="1" fill="currentColor"></circle>
                                        <circle cx="4" cy="12" r="1" fill="currentColor"></circle>
                                        <circle cx="4" cy="18" r="1" fill="currentColor"></circle>
                                    </svg>
                                </button>
                                <button type="button" class="toolbar-btn" onclick="announcementEditor.execCommand('insertOrderedList')" title="æœ‰åºåˆ—è¡¨">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="10" y1="6" x2="21" y2="6"></line>
                                        <line x1="10" y1="12" x2="21" y2="12"></line>
                                        <line x1="10" y1="18" x2="21" y2="18"></line>
                                        <text x="4" y="8" fill="currentColor" font-size="8">1</text>
                                        <text x="4" y="14" fill="currentColor" font-size="8">2</text>
                                        <text x="4" y="20" fill="currentColor" font-size="8">3</text>
                                    </svg>
                                </button>
                                <div class="toolbar-divider"></div>
                                <input type="color" id="text-color-zh" class="toolbar-color" onchange="announcementEditor.execCommand('foreColor', this.value)" title="æ–‡å­—é¢œè‰²" value="#000000">
                                <div class="toolbar-divider"></div>
                                <button type="button" class="toolbar-btn" onclick="announcementEditor.insertImage()" title="æ’å…¥å›¾ç‰‡">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                        <polyline points="21 15 16 10 5 21"></polyline>
                                    </svg>
                                </button>
                                <div class="emoji-picker-wrapper">
                                    <button type="button" class="toolbar-btn" onclick="announcementEditor.toggleEmojiPicker()" title="æ’å…¥è¡¨æƒ…">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                                            <line x1="9" y1="9" x2="9.01" y2="9"></line>
                                            <line x1="15" y1="9" x2="15.01" y2="9"></line>
                                        </svg>
                                    </button>
                                    <div id="emoji-picker" class="emoji-picker" style="display:none;">
                                        <div class="emoji-tabs">
                                            <button type="button" class="emoji-tab active" onclick="announcementEditor.switchEmojiTab('common')">å¸¸ç”¨</button>
                                            <button type="button" class="emoji-tab" onclick="announcementEditor.switchEmojiTab('faces')">è¡¨æƒ…</button>
                                            <button type="button" class="emoji-tab" onclick="announcementEditor.switchEmojiTab('gestures')">æ‰‹åŠ¿</button>
                                            <button type="button" class="emoji-tab" onclick="announcementEditor.switchEmojiTab('objects')">ç‰©å“</button>
                                            <button type="button" class="emoji-tab" onclick="announcementEditor.switchEmojiTab('symbols')">ç¬¦å·</button>
                                        </div>
                                        <div class="emoji-grid" id="emoji-grid-common">
                                            <span onclick="announcementEditor.insertEmoji('ğŸ‰')">ğŸ‰</span>
                                            <span onclick="announcementEditor.insertEmoji('âœ¨')">âœ¨</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸš€')">ğŸš€</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ’¡')">ğŸ’¡</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ”¥')">ğŸ”¥</span>
                                            <span onclick="announcementEditor.insertEmoji('â­')">â­</span>
                                            <span onclick="announcementEditor.insertEmoji('â¤ï¸')">â¤ï¸</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ‘')">ğŸ‘</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ“¢')">ğŸ“¢</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ“Œ')">ğŸ“Œ</span>
                                            <span onclick="announcementEditor.insertEmoji('âœ…')">âœ…</span>
                                            <span onclick="announcementEditor.insertEmoji('âš¡')">âš¡</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ¯')">ğŸ¯</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ’ª')">ğŸ’ª</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸŒŸ')">ğŸŒŸ</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ')">ğŸ</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ†•')">ğŸ†•</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ†™')">ğŸ†™</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ’¯')">ğŸ’¯</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ†')">ğŸ†</span>
                                        </div>
                                        <div class="emoji-grid" id="emoji-grid-faces" style="display:none;">
                                            <span onclick="announcementEditor.insertEmoji('ğŸ˜€')">ğŸ˜€</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ˜ƒ')">ğŸ˜ƒ</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ˜„')">ğŸ˜„</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ˜')">ğŸ˜</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ˜Š')">ğŸ˜Š</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ¥°')">ğŸ¥°</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ˜')">ğŸ˜</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ¤©')">ğŸ¤©</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ˜')">ğŸ˜</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ¤”')">ğŸ¤”</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ§')">ğŸ§</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ˜‡')">ğŸ˜‡</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ¤—')">ğŸ¤—</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ˜®')">ğŸ˜®</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ˜²')">ğŸ˜²</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ¥³')">ğŸ¥³</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ˜´')">ğŸ˜´</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ¤¯')">ğŸ¤¯</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ˜')">ğŸ˜</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ™„')">ğŸ™„</span>
                                        </div>
                                        <div class="emoji-grid" id="emoji-grid-gestures" style="display:none;">
                                            <span onclick="announcementEditor.insertEmoji('ğŸ‘')">ğŸ‘</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ‘')">ğŸ‘</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ‘')">ğŸ‘</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ™Œ')">ğŸ™Œ</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ¤')">ğŸ¤</span>
                                            <span onclick="announcementEditor.insertEmoji('âœ‹')">âœ‹</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ‘‹')">ğŸ‘‹</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ¤')">ğŸ¤</span>
                                            <span onclick="announcementEditor.insertEmoji('âœŒï¸')">âœŒï¸</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ¤Ÿ')">ğŸ¤Ÿ</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ‘Œ')">ğŸ‘Œ</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ‘†')">ğŸ‘†</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ‘‡')">ğŸ‘‡</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ‘ˆ')">ğŸ‘ˆ</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ‘‰')">ğŸ‘‰</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ’ª')">ğŸ’ª</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ™')">ğŸ™</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ¤™')">ğŸ¤™</span>
                                            <span onclick="announcementEditor.insertEmoji('âœï¸')">âœï¸</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ–ï¸')">ğŸ–ï¸</span>
                                        </div>
                                        <div class="emoji-grid" id="emoji-grid-objects" style="display:none;">
                                            <span onclick="announcementEditor.insertEmoji('ğŸ“±')">ğŸ“±</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ’»')">ğŸ’»</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ–¥ï¸')">ğŸ–¥ï¸</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ“Š')">ğŸ“Š</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ“ˆ')">ğŸ“ˆ</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ“')">ğŸ“</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ“š')">ğŸ“š</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ“–')">ğŸ“–</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ”§')">ğŸ”§</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ”¨')">ğŸ”¨</span>
                                            <span onclick="announcementEditor.insertEmoji('âš™ï¸')">âš™ï¸</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ”‘')">ğŸ”‘</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ”’')">ğŸ”’</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ”“')">ğŸ”“</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ’¾')">ğŸ’¾</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ“')">ğŸ“</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ—‚ï¸')">ğŸ—‚ï¸</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ“‹')">ğŸ“‹</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸµ')">ğŸµ</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ¬')">ğŸ¬</span>
                                        </div>
                                        <div class="emoji-grid" id="emoji-grid-symbols" style="display:none;">
                                            <span onclick="announcementEditor.insertEmoji('âœ…')">âœ…</span>
                                            <span onclick="announcementEditor.insertEmoji('âŒ')">âŒ</span>
                                            <span onclick="announcementEditor.insertEmoji('â­•')">â­•</span>
                                            <span onclick="announcementEditor.insertEmoji('â—')">â—</span>
                                            <span onclick="announcementEditor.insertEmoji('â“')">â“</span>
                                            <span onclick="announcementEditor.insertEmoji('âš ï¸')">âš ï¸</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ”´')">ğŸ”´</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸŸ ')">ğŸŸ </span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸŸ¡')">ğŸŸ¡</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸŸ¢')">ğŸŸ¢</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ”µ')">ğŸ”µ</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸŸ£')">ğŸŸ£</span>
                                            <span onclick="announcementEditor.insertEmoji('â¬†ï¸')">â¬†ï¸</span>
                                            <span onclick="announcementEditor.insertEmoji('â¬‡ï¸')">â¬‡ï¸</span>
                                            <span onclick="announcementEditor.insertEmoji('â¡ï¸')">â¡ï¸</span>
                                            <span onclick="announcementEditor.insertEmoji('â¬…ï¸')">â¬…ï¸</span>
                                            <span onclick="announcementEditor.insertEmoji('â†©ï¸')">â†©ï¸</span>
                                            <span onclick="announcementEditor.insertEmoji('ğŸ”„')">ğŸ”„</span>
                                            <span onclick="announcementEditor.insertEmoji('â•')">â•</span>
                                            <span onclick="announcementEditor.insertEmoji('â–')">â–</span>
                                        </div>
                                    </div>
                                </div>
                                <!-- Hidden file input for image upload -->
                                <input type="file" id="announcement-image-input" accept="image/*" style="display:none;" onchange="announcementEditor.handleImageUpload(this)">
                            </div>
                            <!-- Editable Content Area -->
                            <div id="announcement-message" class="rich-text-editor" contenteditable="true" data-placeholder="è¯·è¾“å…¥å…¬å‘Šå†…å®¹... / Please enter announcement content... / ZÉ™hmÉ™t olmasa elan mÉ™zmununu daxil edin..."></div>
                        </div>
                    </div>
                </div>

                <!-- Save Actions -->
                <div style="display:flex;gap:1rem;margin-top:1rem;">
                    <button class="btn btn-secondary" onclick="previewAnnouncement()">ğŸ‘ <span class="lang-zh">é¢„è§ˆ</span><span class="lang-en">Preview</span><span class="lang-az">Ã–nizlÉ™mÉ™</span></button>
                    <button class="btn btn-primary" onclick="saveAnnouncementConfig()">ğŸ’¾ <span class="lang-zh">ä¿å­˜è®¾ç½®</span><span class="lang-en">Save Settings</span><span class="lang-az">ParametrlÉ™ri Saxla</span></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Backup List Modal -->
    <div id="backup-list-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ“¦ .env Backup Files</h3>
                <span class="close" onclick="closeModal('backup-list-modal')">&times;</span>
            </div>
            <div id="backup-list-loading" class="spinner"></div>
            <div id="backup-list-content" style="display:none;">
                <table style="width:100%;">
                    <thead>
                        <tr>
                            <th>Backup File</th>
                            <th>Created</th>
                            <th>Size</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="backup-list-tbody"></tbody>
                </table>
                <p id="no-backups-message" style="display:none;color:#64748b;text-align:center;padding:2rem;">
                    No backup files found. Backups are created automatically when you save settings.
                </p>
            </div>
        </div>
    </div>

    <!-- Create School Modal -->
    <div id="create-school-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><span class="lang-zh">åˆ›å»ºå­¦æ ¡</span><span class="lang-en">Create School</span><span class="lang-az">MÉ™ktÉ™b Yarat</span></h3>
                <span class="close" onclick="closeModal('create-school-modal')">&times;</span>
            </div>
            <div class="form-group">
                <label class="form-label" for="new-school-name"><span class="lang-zh">å­¦æ ¡åç§°</span><span class="lang-en">School Name</span><span class="lang-az">MÉ™ktÉ™b AdÄ±</span> *</label>
                <input type="text" id="new-school-name" name="new-school-name" class="form-input" 
                       placeholder="Beijing High School åŒ—äº¬é«˜ä¸­ / BakÄ± Liseyi" 
                       autocomplete="organization"
                       oninput="autoGenerateSchoolCode()" required>
                <small style="color:#64748b;"><span class="lang-zh">å…ˆè¾“å…¥å­¦æ ¡åç§°ï¼Œä»£ç å°†è‡ªåŠ¨ç”Ÿæˆ</span><span class="lang-en">Enter the school name first, code will be generated automatically</span><span class="lang-az">ÆvvÉ™lcÉ™ mÉ™ktÉ™b adÄ±nÄ± daxil edin, kod avtomatik yaradÄ±lacaq</span></small>
            </div>
            <div class="form-group">
                <label class="form-label" for="new-school-code"><span class="lang-zh">å­¦æ ¡ä»£ç </span><span class="lang-en">School Code</span><span class="lang-az">MÉ™ktÉ™b Kodu</span> *</label>
                <div style="display:flex;gap:0.5rem;">
                    <input type="text" id="new-school-code" name="new-school-code" class="form-input" 
                           placeholder="AUTO-GENERATED / è‡ªåŠ¨ç”Ÿæˆ / AVTOMATIK YARADILIR" required
                           autocomplete="off"
                           style="flex:1;background:#f8fafc;">
                    <button type="button" class="btn btn-secondary" onclick="regenerateSchoolCode()" title="Regenerate Code / é‡æ–°ç”Ÿæˆ / YenidÉ™n Yarat">
                        ğŸ”„
                    </button>
                </div>
                <small style="color:#64748b;"><span class="lang-zh">ä»å­¦æ ¡åç§°è‡ªåŠ¨ç”Ÿæˆï¼ˆå¯ç¼–è¾‘ï¼Œç‚¹å‡» ğŸ”„ é‡æ–°ç”Ÿæˆï¼‰</span><span class="lang-en">Auto-generated from school name (editable, click ğŸ”„ to regenerate)</span><span class="lang-az">MÉ™ktÉ™b adÄ±ndan avtomatik yaradÄ±lÄ±r (redaktÉ™ oluna bilÉ™r, ğŸ”„ dÃ¼ymÉ™sinÉ™ kliklÉ™yin)</span></small>
            </div>
            <div style="padding:1rem;background:#f8fafc;border-radius:8px;margin-bottom:1rem;">
                <small style="color:#64748b;">
                    â„¹ï¸ <strong>Note:</strong> Invitation code will be automatically generated after creation
                </small>
            </div>
            <button class="btn btn-primary" onclick="createSchool()"><span class="lang-zh">åˆ›å»º</span><span class="lang-en">Create</span></button>
        </div>
    </div>

    <!-- Edit School Modal -->
    <div id="edit-school-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><span class="lang-zh">ç¼–è¾‘å­¦æ ¡</span><span class="lang-en">Edit School</span><span class="lang-az">MÉ™ktÉ™bi RedaktÉ™ Et</span></h3>
                <span class="close" onclick="closeModal('edit-school-modal')">&times;</span>
            </div>
            <input type="hidden" id="edit-school-id" name="edit-school-id">
            <div class="form-group">
                <label class="form-label" for="edit-school-code"><span class="lang-zh">å­¦æ ¡ä»£ç </span><span class="lang-en">School Code</span><span class="lang-az">MÉ™ktÉ™b Kodu</span></label>
                <input type="text" id="edit-school-code" name="edit-school-code" class="form-input" autocomplete="off">
            </div>
            <div class="form-group">
                <label class="form-label" for="edit-school-name"><span class="lang-zh">å­¦æ ¡åç§°</span><span class="lang-en">School Name</span><span class="lang-az">MÉ™ktÉ™b AdÄ±</span></label>
                <input type="text" id="edit-school-name" name="edit-school-name" class="form-input" autocomplete="organization">
            </div>
            <div class="form-group">
                <label class="form-label" for="edit-school-invite"><span class="lang-zh">é‚€è¯·ç </span><span class="lang-en">Invitation Code</span><span class="lang-az">DÉ™vÉ™t Kodu</span></label>
                <input type="text" id="edit-school-invite" name="edit-school-invite" class="form-input" autocomplete="off">
            </div>
            <div class="form-group">
                <label class="form-label" for="edit-school-expires"><span class="lang-zh">æœåŠ¡åˆ°æœŸæ—¥æœŸ</span><span class="lang-en">Service Expiration Date</span><span class="lang-az">XidmÉ™t BitmÉ™ Tarixi</span></label>
                <input type="date" id="edit-school-expires" name="edit-school-expires" class="form-input" autocomplete="off">
                <small style="color:#64748b;"><span class="lang-zh">ç•™ç©ºè¡¨ç¤ºæ°¸ä¹…æœ‰æ•ˆ</span><span class="lang-en">Leave empty for no expiration</span><span class="lang-az">BoÅŸ buraxÄ±lsa, mÃ¼ddÉ™tsizdir</span></small>
            </div>
            <div class="form-group">
                <label class="form-label" for="edit-school-active"><span class="lang-zh">è´¦æˆ·çŠ¶æ€</span><span class="lang-en">Account Status</span><span class="lang-az">Hesab Statusu</span></label>
                <select id="edit-school-active" name="edit-school-active" class="form-select">
                    <option value="true"><span class="lang-zh">æ¿€æ´»</span><span class="lang-en">Active</span><span class="lang-az">Aktiv</span></option>
                    <option value="false"><span class="lang-zh">é”å®š</span><span class="lang-en">Locked</span><span class="lang-az">KilidlÉ™nib</span></option>
                </select>
                <small style="color:#64748b;"><span class="lang-zh">é”å®šåè¯¥ç»„ç»‡çš„æ‰€æœ‰ç”¨æˆ·å°†æ— æ³•ç™»å½•</span><span class="lang-en">Locked organizations cannot login</span><span class="lang-az">KilidlÉ™nmiÅŸ tÉ™ÅŸkilatlar giriÅŸ edÉ™ bilmÉ™z</span></small>
            </div>
            <div style="display:flex; gap:0.5rem; align-items:center;">
                <button class="btn btn-secondary" onclick="regenerateInviteCode()"><span class="lang-zh">é‡æ–°ç”Ÿæˆ</span><span class="lang-en">Regenerate</span><span class="lang-az">YenidÉ™n Yarat</span></button>
                <button class="btn btn-primary" onclick="updateSchool()"><span class="lang-zh">ä¿å­˜</span><span class="lang-en">Save</span><span class="lang-az">Saxla</span></button>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="edit-user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><span class="lang-zh">ç¼–è¾‘ç”¨æˆ·</span><span class="lang-en">Edit User</span><span class="lang-az">Ä°stifadÉ™Ã§ini RedaktÉ™ Et</span></h3>
                <span class="close" onclick="closeModal('edit-user-modal')">&times;</span>
            </div>
            <input type="hidden" id="edit-user-id" name="edit-user-id">
            <div class="form-group">
                <label class="form-label" for="edit-user-phone"><span class="lang-zh">æ‰‹æœºå·</span><span class="lang-en">Phone Number</span><span class="lang-az">Telefon NÃ¶mrÉ™si</span> *</label>
                <input type="tel" id="edit-user-phone" name="edit-user-phone" class="form-input" 
                       placeholder="13812345678" maxlength="11" autocomplete="tel" required>
                <small style="color:#64748b;">11-digit Chinese mobile number</small>
            </div>
            <div class="form-group">
                <label class="form-label" for="edit-user-name"><span class="lang-zh">å§“å</span><span class="lang-en">Name</span><span class="lang-az">Ad</span> *</label>
                <input type="text" id="edit-user-name" name="edit-user-name" class="form-input" 
                       placeholder="Zhang Wei" autocomplete="name" required>
                <small style="color:#64748b;">At least 2 characters, no numbers</small>
            </div>
            <div class="form-group">
                <label class="form-label" for="edit-user-org"><span class="lang-zh">å­¦æ ¡</span><span class="lang-en">School</span><span class="lang-az">MÉ™ktÉ™b</span> *</label>
                <select id="edit-user-org" name="edit-user-org" class="form-select" required>
                    <option value="">Loading...</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" for="edit-user-reset-password"><span class="lang-zh">é‡ç½®å¯†ç </span><span class="lang-en">Reset Password</span><span class="lang-az">Parolu SÄ±fÄ±rla</span></label>
                <input type="text" id="edit-user-reset-password" name="edit-user-reset-password" class="form-input" 
                       placeholder="12345678" value="12345678" autocomplete="new-password">
                <small style="color:#64748b;"><span class="lang-zh">ç•™ç©ºæˆ–è¾“å…¥ '12345678' å°†é‡ç½®ä¸ºé»˜è®¤å¯†ç  '12345678'</span><span class="lang-en">Leave empty or enter '12345678' to use default password '12345678'</span><span class="lang-az">BoÅŸ buraxÄ±n vÉ™ ya '12345678' daxil edin, standart parol '12345678' istifadÉ™ olunacaq</span></small>
            </div>
            <div style="display:flex;gap:0.5rem;align-items:center;justify-content:center;">
                <button class="btn btn-primary" onclick="updateUser()"><span class="lang-zh">ä¿å­˜</span><span class="lang-en">Save</span><span class="lang-az">Saxla</span></button>
                <button class="btn btn-warning" onclick="resetPasswordFromModal()"><span class="lang-zh">é‡ç½®å¯†ç </span><span class="lang-en">Reset Password</span><span class="lang-az">Parolu SÄ±fÄ±rla</span></button>
            </div>
        </div>
    </div>

    <!-- Create API Key Modal -->
    <div id="create-apikey-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ”‘ <span class="lang-zh">åˆ›å»ºAPIå¯†é’¥</span><span class="lang-en">Create API Key</span><span class="lang-az">API AÃ§arÄ± Yarat</span></h3>
                <span class="close" onclick="closeModal('create-apikey-modal')">&times;</span>
            </div>
            <div class="form-group">
                <label class="form-label" for="new-apikey-name"><span class="lang-zh">åç§°</span><span class="lang-en">Name</span><span class="lang-az">Ad</span> *</label>
                <input type="text" id="new-apikey-name" name="new-apikey-name" class="form-input" 
                       placeholder="Dify Integration, Mobile App, etc. / Difyé›†æˆ, ç§»åŠ¨åº”ç”¨ç­‰ / Dify Ä°nteqrasiyasÄ±, Mobil TÉ™tbiq vÉ™ s." autocomplete="off" required>
            </div>
            <div class="form-group">
                <label class="form-label" for="new-apikey-description"><span class="lang-zh">æè¿°</span><span class="lang-en">Description</span><span class="lang-az">TÉ™svir</span></label>
                <textarea id="new-apikey-description" name="new-apikey-description" class="form-textarea" style="min-height:80px;"
                          placeholder="Purpose of this API key... / æ­¤APIå¯†é’¥çš„ç”¨é€”... / Bu API aÃ§arÄ±nÄ±n mÉ™qsÉ™di..." autocomplete="off"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label" for="new-apikey-quota"><span class="lang-zh">é…é¢é™åˆ¶ï¼ˆç•™ç©ºè¡¨ç¤ºæ— é™åˆ¶ï¼‰</span><span class="lang-en">Quota Limit (leave empty for unlimited)</span><span class="lang-az">Kvota Limiti (boÅŸ buraxÄ±lsa, limitsizdir)</span></label>
                <input type="number" id="new-apikey-quota" name="new-apikey-quota" class="form-input" 
                       placeholder="10000" autocomplete="off">
            </div>
            <div class="form-group">
                <label class="form-label" for="new-apikey-expires"><span class="lang-zh">æœ‰æ•ˆæœŸï¼ˆå¤©æ•°ï¼Œå¯é€‰ï¼‰</span><span class="lang-en">Expires in (days, optional)</span><span class="lang-az">MÃ¼ddÉ™ti (gÃ¼n, istÉ™yÉ™ baÄŸlÄ±dÄ±r)</span></label>
                <input type="number" id="new-apikey-expires" name="new-apikey-expires" class="form-input" 
                       placeholder="365" autocomplete="off">
            </div>
            <button class="btn btn-primary" onclick="createAPIKey()">ğŸ”‘ <span class="lang-zh">ç”ŸæˆAPIå¯†é’¥</span><span class="lang-en">Generate API Key</span><span class="lang-az">API AÃ§arÄ± Yarat</span></button>
        </div>
    </div>

    <!-- Show API Key Modal -->
    <div id="show-apikey-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">âœ… <span class="lang-zh">APIå¯†é’¥å·²åˆ›å»º</span><span class="lang-en">API Key Created</span><span class="lang-az">API AÃ§arÄ± YaradÄ±ldÄ±</span></h3>
                <span class="close" onclick="closeModal('show-apikey-modal')">&times;</span>
            </div>
            <div class="alert alert-warning show">
                âš ï¸ <strong><span class="lang-zh">é‡è¦ï¼š</span><span class="lang-en">Important:</span><span class="lang-az">Vacibdir:</span></strong> <span class="lang-zh">è¯·å®‰å…¨ä¿å­˜æ­¤å¯†é’¥ - å®ƒä¸ä¼šå†æ¬¡æ˜¾ç¤ºï¼</span><span class="lang-en">Save this key securely - it won't be shown again!</span><span class="lang-az">Bu aÃ§arÄ± tÉ™hlÃ¼kÉ™siz saxlayÄ±n - yenidÉ™n gÃ¶stÉ™rilmÉ™yÉ™cÉ™k!</span>
            </div>
            <div class="form-group">
                <label class="form-label" for="generated-apikey"><span class="lang-zh">APIå¯†é’¥</span><span class="lang-en">API Key</span><span class="lang-az">API AÃ§arÄ±</span></label>
                <input type="text" id="generated-apikey" name="generated-apikey" class="form-input" readonly 
                       autocomplete="off"
                       style="font-family:monospace;font-size:0.875rem;" onclick="this.select()">
            </div>
            <div class="form-group">
                <label class="form-label" for="apikey-usage-instructions"><span class="lang-zh">ä½¿ç”¨è¯´æ˜</span><span class="lang-en">Usage Instructions</span><span class="lang-az">Ä°stifadÉ™ TÉ™limatlarÄ±</span></label>
                <textarea id="apikey-usage-instructions" name="apikey-usage-instructions" readonly class="form-textarea" style="min-height:100px;" autocomplete="off">Add this header to your HTTP requests:
X-API-Key: [your-key-here]

Example (curl):
curl -X POST http://your-server/api/generate_graph \
  -H "X-API-Key: [your-key]" \
  -H "Content-Type: application/json" \
  -d '{"prompt":"test","diagram_type":"mind_map"}'</textarea>
            </div>
            <button class="btn btn-primary" onclick="copyAPIKey()">ğŸ“‹ <span class="lang-zh">å¤åˆ¶åˆ°å‰ªè´´æ¿</span><span class="lang-en">Copy to Clipboard</span><span class="lang-az">MÃ¼badilÉ™ BuferinÉ™ Kopyala</span></button>
        </div>
    </div>

    <!-- Edit API Key Modal -->
    <div id="edit-apikey-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">âœï¸ <span class="lang-zh">ç¼–è¾‘APIå¯†é’¥</span><span class="lang-en">Edit API Key</span><span class="lang-az">API AÃ§arÄ±nÄ± RedaktÉ™ Et</span></h3>
                <span class="close" onclick="closeModal('edit-apikey-modal')">&times;</span>
            </div>
            <input type="hidden" id="edit-apikey-id" name="edit-apikey-id">
            <div class="form-group">
                <label class="form-label" for="edit-apikey-name"><span class="lang-zh">åç§°</span><span class="lang-en">Name</span><span class="lang-az">Ad</span></label>
                <input type="text" id="edit-apikey-name" name="edit-apikey-name" class="form-input" autocomplete="off">
            </div>
            <div class="form-group">
                <label class="form-label" for="edit-apikey-description"><span class="lang-zh">æè¿°</span><span class="lang-en">Description</span><span class="lang-az">TÉ™svir</span></label>
                <textarea id="edit-apikey-description" name="edit-apikey-description" class="form-textarea" style="min-height:80px;" autocomplete="off"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label" for="edit-apikey-quota"><span class="lang-zh">é…é¢é™åˆ¶ï¼ˆç•™ç©ºè¡¨ç¤ºæ— é™åˆ¶ï¼‰</span><span class="lang-en">Quota Limit (empty for unlimited)</span><span class="lang-az">Kvota Limiti (boÅŸ buraxÄ±lsa, limitsizdir)</span></label>
                <input type="number" id="edit-apikey-quota" name="edit-apikey-quota" class="form-input" autocomplete="off">
            </div>
            <div class="form-group">
                <label class="form-label" for="edit-apikey-usage"><span class="lang-zh">ä½¿ç”¨æ¬¡æ•°ï¼ˆå¦‚éœ€è¦å¯é‡ç½®ä¸º0ï¼‰</span><span class="lang-en">Usage Count (reset to 0 if needed)</span><span class="lang-az">Ä°stifadÉ™ SayÄ± (lazÄ±m olsa, 0-a sÄ±fÄ±rlayÄ±n)</span></label>
                <input type="number" id="edit-apikey-usage" name="edit-apikey-usage" class="form-input" autocomplete="off">
            </div>
            <button class="btn btn-primary" onclick="updateAPIKey()">ğŸ’¾ <span class="lang-zh">ä¿å­˜æ›´æ”¹</span><span class="lang-en">Save Changes</span><span class="lang-az">DÉ™yiÅŸikliklÉ™ri Saxla</span></button>
        </div>
    </div>

    <!-- Share Invitation Info Modal -->
    <div id="share-invite-modal" class="modal">
        <div class="modal-content" style="max-width:400px;">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ“¤ <span class="lang-zh">åˆ†äº«é‚€è¯·ä¿¡æ¯</span><span class="lang-en">Share Invitation Info</span><span class="lang-az">DÉ™vÉ™t MÉ™lumatÄ±nÄ± PaylaÅŸ</span></h3>
                <span class="close" onclick="closeModal('share-invite-modal')">&times;</span>
            </div>
            <div style="margin-bottom:1rem;color:#64748b;font-size:0.9rem;">
                <span class="lang-zh">å¤åˆ¶ä»¥ä¸‹ä¿¡æ¯åˆ†äº«ç»™ç”¨æˆ·ï¼š</span>
                <span class="lang-en">Copy the information below to share with users:</span>
            </div>
            <div class="form-group">
                <label class="form-label" for="share-invite-text" style="display:none;">Share Invitation Text</label>
                <textarea id="share-invite-text" name="share-invite-text" class="form-textarea" readonly
                          style="min-height:100px;font-size:1rem;line-height:1.6;background:#f8fafc;border:2px solid #667eea;font-family:inherit;"
                          autocomplete="off"
                          onclick="this.select()"></textarea>
            </div>
            <button class="btn btn-primary" onclick="selectAndCopyShareText(this)" style="width:100%;">
                ğŸ“‹ <span class="lang-zh">é€‰ä¸­å¹¶å¤åˆ¶</span><span class="lang-en">Select and Copy</span>
            </button>
            <small style="display:block;margin-top:1rem;color:#94a3b8;text-align:center;">
                <span class="lang-zh">ç‚¹å‡»æ–‡æœ¬æ¡†å³å¯é€‰ä¸­ï¼Œæˆ–ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®è‡ªåŠ¨å¤åˆ¶</span>
                <span class="lang-en">Click the text box to select, or click the button above to copy automatically</span>
            </small>
        </div>
    </div>

    <!-- Trend Chart Modal -->
    <div id="trend-chart-modal" class="modal">
        <div class="modal-content chart-modal">
            <div class="modal-header">
                <h3 class="modal-title" id="trend-chart-title">
                    <span class="lang-zh">è¶‹åŠ¿å›¾è¡¨</span><span class="lang-en">Trend Chart</span>
                </h3>
                <span class="close" onclick="closeModal('trend-chart-modal')">&times;</span>
            </div>
            <div class="chart-container">
                <canvas id="trend-chart-canvas"></canvas>
            </div>
        </div>
    </div>

    <!-- Unauthenticated Overlay -->
    <div id="auth-required-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9999; justify-content:center; align-items:center;">
        <div style="background:white; border-radius:20px; padding:3rem; text-align:center; max-width:500px; box-shadow:0 20px 60px rgba(0,0,0,0.5);">
            <div style="font-size:4rem; margin-bottom:1rem;">ğŸ”’</div>
            <h2 style="font-size:1.75rem; margin-bottom:1rem; color:#1e293b;">Admin Authentication Required</h2>
            <p style="color:#64748b; margin-bottom:2rem;">Please authenticate to access the admin panel</p>
            
            <div style="display:grid; gap:1rem;">
                <a href="/auth?redirect=/admin" class="btn btn-primary" style="display:block; text-decoration:none; padding:1rem;">
                    ğŸ” Standard Login / æ ‡å‡†ç™»å½•
                </a>
                <a href="/demo?redirect=/admin" class="btn btn-secondary" style="display:block; text-decoration:none; padding:1rem;">
                    ğŸ¯ Demo Mode / æ¼”ç¤ºæ¨¡å¼
                </a>
            </div>
            
            <p style="color:#94a3b8; font-size:0.875rem; margin-top:1.5rem;">
                Admins can access this panel from any authentication mode
            </p>
        </div>
    </div>

    <script src="/static/js/auth-helper.js?v={{ version }}"></script>
    <script src="/static/js/chart.umd.min.js?v={{ version }}"></script>
    <script src="/static/js/chartjs-plugin-zoom.min.js?v={{ version }}"></script>
    <script src="/static/js/chartjs-plugin-datalabels.min.js?v={{ version }}"></script>
    <script>
        // Store app version for cache detection
        window.MINDGRAPH_VERSION = '{{ version }}';
        
        // Cache detection and refresh mechanism
        (function() {
            const CURRENT_VERSION = '{{ version }}';
            const VERSION_STORAGE_KEY = 'mindgraph_app_version';
            const CACHE_DETECTED_KEY = 'mindgraph_cache_detected';
            
            // Helper function to safely access localStorage
            const safeLocalStorage = {
                getItem: (key) => {
                    try {
                        return localStorage.getItem(key);
                    } catch (e) {
                        return null;
                    }
                },
                setItem: (key, value) => {
                    try {
                        localStorage.setItem(key, value);
                        return true;
                    } catch (e) {
                        return false;
                    }
                }
            };
            
            // Helper function to safely access sessionStorage
            const safeSessionStorage = {
                getItem: (key) => {
                    try {
                        return sessionStorage.getItem(key);
                    } catch (e) {
                        return null;
                    }
                },
                setItem: (key, value) => {
                    try {
                        sessionStorage.setItem(key, value);
                        return true;
                    } catch (e) {
                        return false;
                    }
                },
                removeItem: (key) => {
                    try {
                        sessionStorage.removeItem(key);
                    } catch (e) {
                        // Ignore errors
                    }
                }
            };
            
            // Get stored version
            const storedVersion = safeLocalStorage.getItem(VERSION_STORAGE_KEY);
            const cacheDetected = safeSessionStorage.getItem(CACHE_DETECTED_KEY);
            
            // Check if version changed (cache detected)
            if (storedVersion && storedVersion !== CURRENT_VERSION && !cacheDetected) {
                // Mark that we've detected cache for this session
                safeSessionStorage.setItem(CACHE_DETECTED_KEY, 'true');
                
                // Show cache warning notification
                const showCacheWarning = () => {
                    const currentLang = localStorage.getItem('language') || 'zh';
                    const isZh = currentLang === 'zh';
                    
                    const warningHtml = `
                        <div id="cache-warning" style="
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
                            color: white;
                            padding: 20px 25px;
                            border-radius: 12px;
                            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
                            z-index: 10000;
                            max-width: 400px;
                            animation: slideIn 0.3s ease-out;
                        ">
                            <style>
                                @keyframes slideIn {
                                    from {
                                        transform: translateX(100%);
                                        opacity: 0;
                                    }
                                    to {
                                        transform: translateX(0);
                                        opacity: 1;
                                    }
                                }
                                @keyframes slideOut {
                                    from {
                                        transform: translateX(0);
                                        opacity: 1;
                                    }
                                    to {
                                        transform: translateX(100%);
                                        opacity: 0;
                                    }
                                }
                            </style>
                            <div style="display: flex; align-items: flex-start; gap: 15px;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 16px; margin-bottom: 8px;">
                                        ${isZh ? 'âš ï¸ æ£€æµ‹åˆ°æ—§ç‰ˆæœ¬ç¼“å­˜' : 'âš ï¸ Old Cache Detected'}
                                    </div>
                                    <div style="font-size: 14px; opacity: 0.95; line-height: 1.5; margin-bottom: 12px;">
                                        ${isZh 
                                            ? `åº”ç”¨å·²æ›´æ–°åˆ°ç‰ˆæœ¬ ${CURRENT_VERSION}ï¼Œä½†æ‚¨å¯èƒ½åœ¨ä½¿ç”¨æ—§ç‰ˆæœ¬ç¼“å­˜ã€‚è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®åˆ·æ–°ï¼Œæˆ–ä½¿ç”¨å¿«æ·é”®å¼ºåˆ¶åˆ·æ–°é¡µé¢ä»¥è·å¾—æœ€æ–°åŠŸèƒ½ã€‚`
                                            : `Application updated to version ${CURRENT_VERSION}, but you may be using cached files. Click the button below to refresh, or use keyboard shortcut to hard refresh and get the latest features.`
                                        }
                                    </div>
                                    <div style="margin-bottom: 12px; padding: 10px; background: rgba(255, 255, 255, 0.15); border-radius: 6px; border-left: 3px solid rgba(255, 255, 255, 0.5);">
                                        <div style="font-size: 13px; font-weight: 600; margin-bottom: 4px;">
                                            ${isZh ? 'âŒ¨ï¸ å¦‚ä½•å¼ºåˆ¶åˆ·æ–°ï¼š' : 'âŒ¨ï¸ How to Hard Refresh:'}
                                        </div>
                                        <div style="font-size: 12px; opacity: 0.95; line-height: 1.6;">
                                            ${isZh 
                                                ? 'â€¢ Windows/Linux: æŒ‰ <kbd style="background: rgba(255,255,255,0.3); padding: 2px 6px; border-radius: 3px; font-family: monospace;">Ctrl</kbd> + <kbd style="background: rgba(255,255,255,0.3); padding: 2px 6px; border-radius: 3px; font-family: monospace;">Shift</kbd> + <kbd style="background: rgba(255,255,255,0.3); padding: 2px 6px; border-radius: 3px; font-family: monospace;">R</kbd><br>â€¢ Mac: æŒ‰ <kbd style="background: rgba(255,255,255,0.3); padding: 2px 6px; border-radius: 3px; font-family: monospace;">Cmd</kbd> + <kbd style="background: rgba(255,255,255,0.3); padding: 2px 6px; border-radius: 3px; font-family: monospace;">Shift</kbd> + <kbd style="background: rgba(255,255,255,0.3); padding: 2px 6px; border-radius: 3px; font-family: monospace;">R</kbd>'
                                                : 'â€¢ Windows/Linux: Press <kbd style="background: rgba(255,255,255,0.3); padding: 2px 6px; border-radius: 3px; font-family: monospace;">Ctrl</kbd> + <kbd style="background: rgba(255,255,255,0.3); padding: 2px 6px; border-radius: 3px; font-family: monospace;">Shift</kbd> + <kbd style="background: rgba(255,255,255,0.3); padding: 2px 6px; border-radius: 3px; font-family: monospace;">R</kbd><br>â€¢ Mac: Press <kbd style="background: rgba(255,255,255,0.3); padding: 2px 6px; border-radius: 3px; font-family: monospace;">Cmd</kbd> + <kbd style="background: rgba(255,255,255,0.3); padding: 2px 6px; border-radius: 3px; font-family: monospace;">Shift</kbd> + <kbd style="background: rgba(255,255,255,0.3); padding: 2px 6px; border-radius: 3px; font-family: monospace;">R</kbd>'
                                            }
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 10px;">
                                        <button id="cache-refresh-btn" style="
                                            background: white;
                                            color: #ff6b6b;
                                            border: none;
                                            padding: 8px 16px;
                                            border-radius: 6px;
                                            font-weight: 600;
                                            cursor: pointer;
                                            font-size: 14px;
                                            transition: all 0.2s;
                                        " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                            ${isZh ? 'ğŸ”„ ç«‹å³åˆ·æ–°' : 'ğŸ”„ Refresh Now'}
                                        </button>
                                        <button id="cache-dismiss-btn" style="
                                            background: rgba(255, 255, 255, 0.2);
                                            color: white;
                                            border: 1px solid rgba(255, 255, 255, 0.3);
                                            padding: 8px 16px;
                                            border-radius: 6px;
                                            font-weight: 600;
                                            cursor: pointer;
                                            font-size: 14px;
                                            transition: all 0.2s;
                                        " onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'">
                                            ${isZh ? 'ç¨å' : 'Later'}
                                        </button>
                                    </div>
                                </div>
                                <button id="cache-close-btn" style="
                                    background: rgba(255, 255, 255, 0.2);
                                    border: none;
                                    color: white;
                                    width: 24px;
                                    height: 24px;
                                    border-radius: 50%;
                                    cursor: pointer;
                                    font-size: 18px;
                                    line-height: 1;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    transition: all 0.2s;
                                " onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'">Ã—</button>
                            </div>
                        </div>
                    `;
                    
                    document.body.insertAdjacentHTML('beforeend', warningHtml);
                    
                    // Refresh button - force reload (prevent multiple clicks)
                    let isRefreshing = false;
                    document.getElementById('cache-refresh-btn').addEventListener('click', () => {
                        if (isRefreshing) return; // Prevent multiple clicks
                        isRefreshing = true;
                        safeLocalStorage.setItem(VERSION_STORAGE_KEY, CURRENT_VERSION);
                        safeSessionStorage.removeItem(CACHE_DETECTED_KEY);
                        // Use modern reload method with cache bypass
                        window.location.reload();
                    });
                    
                    // Dismiss button - hide for this session
                    document.getElementById('cache-dismiss-btn').addEventListener('click', () => {
                        document.getElementById('cache-warning').remove();
                    });
                    
                    // Close button
                    document.getElementById('cache-close-btn').addEventListener('click', () => {
                        document.getElementById('cache-warning').remove();
                    });
                    
                    // Auto-dismiss after 30 seconds
                    setTimeout(() => {
                        const warning = document.getElementById('cache-warning');
                        if (warning) {
                            warning.style.animation = 'slideOut 0.3s ease-out';
                            warning.style.animationFillMode = 'forwards';
                            setTimeout(() => warning.remove(), 300);
                        }
                    }, 30000);
                };
                
                // Show warning after page loads
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', showCacheWarning);
                } else {
                    showCacheWarning();
                }
            }
            
            // Update stored version (always, even if cache detection failed)
            safeLocalStorage.setItem(VERSION_STORAGE_KEY, CURRENT_VERSION);
        })();
    </script>
    <script>
        // Check admin access without automatic redirect
        async function checkAdminAuth() {
            const authenticated = await auth.isAuthenticated();
            if (!authenticated) {
                // Show overlay instead of redirecting
                document.getElementById('auth-required-overlay').style.display = 'flex';
                return false;
            }
            
            // Verify user is admin
            try {
                const response = await auth.fetch('/api/auth/me');
                const user = await response.json();
                
                // Check if user is admin by making a test admin API call
                const adminCheck = await auth.fetch('/api/auth/admin/stats');
                if (!adminCheck.ok) {
                    // User is authenticated but not admin
                    alert('âš ï¸ Admin access denied.\n\næ‚¨ä¸æ˜¯ç®¡ç†å‘˜ï¼Œæ— æ³•è®¿é—®æ­¤é¡µé¢ã€‚\nYou are not an administrator and cannot access this page.');
                    window.location.href = '/editor';
                    return false;
                }
                
                // Update admin name in header
                document.getElementById('adminName').textContent = user.name || 'Admin';
                
                return true;
            } catch (error) {
                console.error('Admin check failed:', error);
                document.getElementById('auth-required-overlay').style.display = 'flex';
                return false;
            }
        }
        
        // Global state (must be declared before functions use them)
        let currentTab = 'dashboard';
        let schools = [];
        let users = [];
        let currentLang = 'en'; // Default to English
        
        // User pagination state
        let usersCurrentPage = 1;
        let usersPageSize = 50;
        let usersTotalPages = 1;
        let usersTotal = 0;

        // Check on page load
        checkAdminAuth();
        
        // Initialize language
        initLanguage();

        // Toggle language between English, Chinese, and Azerbaijani
        function toggleLanguage() {
            const languages = ['en', 'zh', 'az'];
            const currentIndex = languages.indexOf(currentLang);
            const nextIndex = (currentIndex + 1) % languages.length;
            currentLang = languages[nextIndex];
            
            // Apply language to all elements
            applyCurrentLanguage();
            
            // Save language preference
            localStorage.setItem('adminLanguage', currentLang);
        }

        // Apply current language to all lang-* elements (call after dynamic content injection)
        function applyCurrentLanguage() {
            document.querySelectorAll('.lang-en, .lang-zh, .lang-az').forEach(el => {
                el.style.display = 'none';
            });
            
            if (currentLang === 'zh') {
                document.querySelectorAll('.lang-zh').forEach(el => el.style.display = 'inline');
            } else if (currentLang === 'az') {
                document.querySelectorAll('.lang-az').forEach(el => el.style.display = 'inline');
                // Fallback to English if Azerbaijani not available
                if (document.querySelectorAll('.lang-az').length === 0) {
                    document.querySelectorAll('.lang-en').forEach(el => el.style.display = 'inline');
                }
            } else {
                document.querySelectorAll('.lang-en').forEach(el => el.style.display = 'inline');
            }
        }

        // Initialize language on page load
        function initLanguage() {
            const savedLang = localStorage.getItem('adminLanguage');
            if (savedLang && ['en', 'zh', 'az'].includes(savedLang)) {
                currentLang = savedLang;
            }
            applyCurrentLanguage();
        }

        // Tab switching
        function switchTab(tab, buttonElement) {
            // Update tabs - remove active class from all tabs
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            // Add active class to the clicked button
            if (buttonElement) {
                buttonElement.classList.add('active');
            } else {
                // Fallback: find button by data-tab attribute
                const tabButton = document.querySelector(`.tab[data-tab="${tab}"]`);
                if (tabButton) {
                    tabButton.classList.add('active');
                }
            }
            
            // Show the corresponding tab content
            document.getElementById(tab + '-tab').classList.add('active');
            currentTab = tab;

            // Load data
            if (tab === 'dashboard') loadDashboard();
            if (tab === 'tokens') loadTokenStats();
            if (tab === 'schools') loadSchools();
            if (tab === 'users') {
                loadUserFilters(); // Load filter dropdown options
                loadUsers(); // Load user list
            }
            if (tab === 'apikeys') loadAPIKeys();
            if (tab === 'announcement') loadAnnouncementConfig();
        }

        // Show alert
        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alert');
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
            setTimeout(() => alert.classList.remove('show'), 5000);
        }

        // Modal functions
        function showCreateSchoolModal() {
            // Clear form first
            document.getElementById('new-school-name').value = '';
            document.getElementById('new-school-code').value = '';
            document.getElementById('create-school-modal').classList.add('show');
        }

        function openModal(id) {
            document.getElementById(id).classList.add('show');
        }
        
        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
            // Destroy chart when closing trend modal
            if (id === 'trend-chart-modal' && trendChartInstance) {
                trendChartInstance.destroy();
                trendChartInstance = null;
            }
        }

        // Auto-generate school code from school name
        function autoGenerateSchoolCode() {
            const nameInput = document.getElementById('new-school-name');
            const codeInput = document.getElementById('new-school-code');
            const name = nameInput.value.trim();
            
            if (!name) {
                codeInput.value = '';
                return;
            }
            
            // Extract English letters and Chinese characters
            const letters = name.match(/[A-Za-z]+/g) || [];
            const chinese = name.match(/[\u4e00-\u9fa5]+/g) || [];
            
            let prefix = '';
            
            // Prefer English letters for code generation
            if (letters.length > 0) {
                prefix = letters.join('').toUpperCase();
            } else if (chinese.length > 0) {
                // Use first letter of Chinese pinyin or just use first character
                // For simplicity, we'll just use "SCHOOL" as fallback
                prefix = 'SCHOOL';
            }
            
            // Take first 2-4 letters for prefix
            prefix = prefix.substring(0, Math.min(prefix.length, 4));
            if (prefix.length < 2) prefix = prefix.padEnd(2, 'X');
            
            // Add random suffix with timestamp component for uniqueness
            const timestamp = Date.now().toString().slice(-3);
            const randomChars = Math.random().toString(36).substring(2, 5).toUpperCase();
            
            codeInput.value = `${prefix}-${randomChars}${timestamp}`;
        }
        
        // Regenerate school code manually
        function regenerateSchoolCode() {
            const nameInput = document.getElementById('new-school-name');
            const codeInput = document.getElementById('new-school-code');
            const name = nameInput.value.trim();
            
            if (!name) {
                showAlert('è¯·å…ˆè¾“å…¥å­¦æ ¡åç§° Please enter school name first', 'error');
                return;
            }
            
            // Generate with different random seed
            autoGenerateSchoolCode();
        }

        // Format numbers with K/M suffix for readability (shared function)
        function formatNumber(num) {
            if (num >= 1000000000000) {
                return Math.round(num / 1000000000000) + 'T';
            } else if (num >= 1000000000) {
                return Math.round(num / 1000000000) + 'G';
            } else if (num >= 1000000) {
                return Math.round(num / 1000000) + 'M';
            } else if (num >= 1000) {
                return Math.round(num / 1000) + 'K';
            }
            return num.toString();
        }

        // Format numbers for chart labels (cute short format)
        function formatChartLabel(value) {
            if (value >= 1000000) {
                return (value / 1000000).toFixed(1) + 'M';
            } else if (value >= 1000) {
                return (value / 1000).toFixed(1) + 'K';
            }
            return value.toString();
        }

        // Mask phone number for privacy (e.g., 13812345678 -> 138****5678)
        function maskPhone(phone) {
            if (!phone || phone.length < 7) return phone;
            // For Chinese phone numbers (11 digits): show first 3 and last 4
            if (phone.length === 11) {
                return phone.slice(0, 3) + '****' + phone.slice(-4);
            }
            // For other phone numbers: show first 3 and last 4, mask middle
            const visibleStart = 3;
            const visibleEnd = 4;
            const maskedLength = phone.length - visibleStart - visibleEnd;
            if (maskedLength > 0) {
                return phone.slice(0, visibleStart) + '*'.repeat(Math.min(maskedLength, 4)) + phone.slice(-visibleEnd);
            }
            return phone;
        }

        // Chart instance for trend chart
        let trendChartInstance = null;

        // Register Chart.js plugins when available
        if (typeof Chart !== 'undefined') {
            // Register zoom plugin if available
            if (typeof chartjsPluginZoom !== 'undefined') {
                Chart.register(chartjsPluginZoom);
            }
            // Register datalabels plugin if available
            if (typeof ChartDataLabels !== 'undefined') {
                Chart.register(ChartDataLabels);
            }
        }

        // Zoom chart functions
        function zoomChart(direction) {
            if (!trendChartInstance) return;
            
            try {
                if (direction === 'in') {
                    trendChartInstance.zoom(1.2);
                } else if (direction === 'out') {
                    trendChartInstance.zoom(0.8);
                }
            } catch (e) {
                console.warn('Zoom function not available:', e);
            }
        }

        function resetChartZoom() {
            if (!trendChartInstance) return;
            try {
                trendChartInstance.resetZoom();
            } catch (e) {
                console.warn('Reset zoom function not available:', e);
            }
        }

        // Show trend chart modal
        async function showTrendChart(metric, cardElement) {
            const modal = document.getElementById('trend-chart-modal');
            const titleElement = document.getElementById('trend-chart-title');
            const canvas = document.getElementById('trend-chart-canvas');
            
            // Map token-specific metrics to API metric and days
            let apiMetric = metric;
            let days = 30;
            
            if (metric === 'token-today') {
                apiMetric = 'tokens';
                days = 1;
            } else if (metric === 'token-week') {
                apiMetric = 'tokens';
                days = 7;
            } else if (metric === 'token-month') {
                apiMetric = 'tokens';
                days = 30;
            } else if (metric === 'token-total') {
                apiMetric = 'tokens';
                days = 90; // Show last 90 days for total
            }
            
            // Set title based on metric
            const titles = {
                'users': { zh: 'æ€»ç”¨æˆ·æ•°è¶‹åŠ¿', en: 'Total Users Trend' },
                'organizations': { zh: 'å­¦æ ¡æ•°é‡è¶‹åŠ¿', en: 'Organizations Trend' },
                'registrations': { zh: 'æ¯æ—¥æ³¨å†Œè¶‹åŠ¿', en: 'Daily Registrations Trend' },
                'tokens': { zh: 'Tokenä½¿ç”¨è¶‹åŠ¿', en: 'Token Usage Trend' },
                'token-today': { zh: 'ä»Šæ—¥Tokenè¶‹åŠ¿', en: 'Today Token Trend' },
                'token-week': { zh: 'è¿‡å»ä¸€å‘¨Tokenè¶‹åŠ¿', en: 'Past Week Token Trend' },
                'token-month': { zh: 'è¿‡å»ä¸€æœˆTokenè¶‹åŠ¿', en: 'Past Month Token Trend' },
                'token-total': { zh: 'Tokenæ€»è®¡è¶‹åŠ¿', en: 'Total Token Trend' }
            };
            
            const title = titles[metric] || { zh: 'è¶‹åŠ¿å›¾è¡¨', en: 'Trend Chart' };
            titleElement.innerHTML = `<span class="lang-zh">${title.zh}</span><span class="lang-en">${title.en}</span>`;
            applyCurrentLanguage();
            
            // Show modal
            modal.classList.add('show');
            
            // Show loading state
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.font = '16px Inter';
            ctx.fillStyle = '#64748b';
            ctx.textAlign = 'center';
            ctx.fillText('Loading...', canvas.width / 2, canvas.height / 2);
            
            try {
                // Fetch trends data
                const response = await auth.fetch(`/api/auth/admin/stats/trends?metric=${apiMetric}&days=${days}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch trends data');
                }
                
                const data = await response.json();
                
                // Destroy existing chart if it exists
                if (trendChartInstance) {
                    trendChartInstance.destroy();
                }
                
                // Prepare chart data
                const labels = data.data.map(item => {
                    const date = new Date(item.date);
                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                });
                
                const values = data.data.map(item => item.value);
                
                // Calculate adaptive Y-axis range
                const maxValue = Math.max(...values);
                const minValue = Math.min(...values);
                const range = maxValue - minValue;
                // Handle edge case when all values are the same (e.g., single day)
                const padding = range === 0 ? maxValue * 0.1 : range * 0.1; // 10% padding
                const yMin = Math.max(0, minValue - padding);
                const yMax = maxValue + padding;
                
                // Chart configuration
                const chartConfig = {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: title.en,
                            data: values,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            pointBackgroundColor: '#667eea',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                titleFont: { size: 14, weight: 'bold' },
                                bodyFont: { size: 13 },
                                cornerRadius: 8,
                                displayColors: false
                            },
                            datalabels: {
                                anchor: 'end',
                                align: 'top',
                                offset: 4,
                                color: '#667eea',
                                font: {
                                    size: 10,
                                    weight: 'bold'
                                },
                                formatter: function(value) {
                                    return formatChartLabel(value);
                                },
                                display: function(context) {
                                    // Show labels on first dataset (main line)
                                    return context.datasetIndex === 0;
                                },
                                clamp: true,
                                clip: false
                            },
                            zoom: {
                                zoom: {
                                    wheel: {
                                        enabled: true,
                                        speed: 0.1
                                    },
                                    pinch: {
                                        enabled: true
                                    },
                                    mode: 'xy',
                                    onZoomComplete: function({chart}) {
                                        // Keep chart centered after zoom
                                        chart.update('none');
                                    }
                                },
                                pan: {
                                    enabled: true,
                                    mode: 'xy'
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                min: yMin,
                                max: yMax,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                },
                                ticks: {
                                    color: '#64748b',
                                    font: { size: 12 },
                                    callback: function(value) {
                                        return formatChartLabel(value);
                                    }
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    color: '#64748b',
                                    font: { size: 11 },
                                    maxRotation: 45,
                                    minRotation: 45
                                },
                                afterFit: function(scale) {
                                    // Keep x-axis centered
                                }
                            }
                        },
                        animation: {
                            duration: 0
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        }
                    }
                };
                
                // For tokens, add input/output lines if available
                if ((metric === 'tokens' || metric.startsWith('token-')) && data.data[0] && data.data[0].input !== undefined) {
                    const inputValues = data.data.map(item => item.input || 0);
                    const outputValues = data.data.map(item => item.output || 0);
                    
                    chartConfig.data.datasets.push({
                        label: 'Input Tokens',
                        data: inputValues,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.4,
                        pointRadius: 2,
                        pointHoverRadius: 4
                    });
                    
                    chartConfig.data.datasets.push({
                        label: 'Output Tokens',
                        data: outputValues,
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.4,
                        pointRadius: 2,
                        pointHoverRadius: 4
                    });
                    
                    // Update datalabels to show on all datasets for tokens
                    chartConfig.options.plugins.datalabels.display = function(context) {
                        return true; // Show on all token lines
                    };
                    chartConfig.options.plugins.datalabels.color = function(context) {
                        const colors = ['#667eea', '#10b981', '#f59e0b'];
                        return colors[context.datasetIndex] || '#667eea';
                    };
                    
                    chartConfig.options.plugins.legend.display = true;
                    chartConfig.options.plugins.legend.position = 'top';
                    chartConfig.options.plugins.legend.labels = {
                        color: '#64748b',
                        font: { size: 12 },
                        padding: 15,
                        usePointStyle: true
                    };
                }
                
                // Create chart
                trendChartInstance = new Chart(ctx, chartConfig);
                
            } catch (error) {
                console.error('Error loading trend chart:', error);
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.font = '16px Inter';
                ctx.fillStyle = '#ef4444';
                ctx.textAlign = 'center';
                ctx.fillText('Failed to load chart data', canvas.width / 2, canvas.height / 2);
                showAlert('Failed to load trend data', 'error');
            }
        }

        // Dashboard
        async function loadDashboard() {
            try {
                const response = await auth.fetch('/api/auth/admin/stats');
                const stats = await response.json();

                document.getElementById('stat-users').textContent = stats.total_users;
                document.getElementById('stat-orgs').textContent = stats.total_organizations;
                document.getElementById('stat-recent').textContent = stats.recent_registrations;
                
                // Fetch total token stats
                try {
                    const tokenResponse = await auth.fetch('/api/auth/admin/token-stats');
                    const tokenData = await tokenResponse.json();
                    const totalStats = tokenData.total || { input_tokens: 0, output_tokens: 0 };
                    const inputTokens = totalStats.input_tokens || 0;
                    const outputTokens = totalStats.output_tokens || 0;
                    
                    const formattedInput = formatNumber(inputTokens);
                    const formattedOutput = formatNumber(outputTokens);
                    document.getElementById('stat-tokens').textContent = `${formattedInput}+${formattedOutput}`;
                } catch (error) {
                    // Fallback to week stats if token-stats endpoint fails
                    const tokenStats = stats.token_stats || { input_tokens: 0, output_tokens: 0 };
                    const inputTokens = tokenStats.input_tokens || 0;
                    const outputTokens = tokenStats.output_tokens || 0;
                    
                    const formattedInput = formatNumber(inputTokens);
                    const formattedOutput = formatNumber(outputTokens);
                    document.getElementById('stat-tokens').textContent = `${formattedInput}+${formattedOutput}`;
                }

                // Organization distribution - Top 10 by token usage (active schools)
                const dist = document.getElementById('org-distribution');
                const tokenStatsByOrg = stats.token_stats_by_org || {};
                const usersByOrg = stats.users_by_org || {};
                
                // Sort by total token usage (descending) to show most active schools
                const sortedOrgs = Object.entries(tokenStatsByOrg)
                    .sort((a, b) => (b[1].total_tokens || 0) - (a[1].total_tokens || 0))
                    .slice(0, 10);  // Take top 10 only
                
                if (sortedOrgs.length === 0) {
                    dist.innerHTML = '<div style="color:#64748b;text-align:center;padding:2rem;"><span class="lang-zh">æš‚æ— æ´»è·ƒå­¦æ ¡æ•°æ®</span><span class="lang-en">No active schools yet</span></div>';
                } else {
                    dist.innerHTML = sortedOrgs.map(([org, orgTokenStats], index) => {
                        const rank = index + 1;
                        let rankBadge = '';
                        let rankStyle = '';
                        
                        if (rank === 1) {
                            rankBadge = 'ğŸ¥‡';
                            rankStyle = 'background:linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);color:#000;';
                        } else if (rank === 2) {
                            rankBadge = 'ğŸ¥ˆ';
                            rankStyle = 'background:linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%);color:#000;';
                        } else if (rank === 3) {
                            rankBadge = 'ğŸ¥‰';
                            rankStyle = 'background:linear-gradient(135deg, #cd7f32 0%, #d4a574 100%);color:#000;';
                        } else {
                            rankBadge = `#${rank}`;
                            rankStyle = 'background:#f1f5f9;color:#64748b;';
                        }
                        
                        // Get user count for this organization
                        const userCount = usersByOrg[org] || 0;
                        
                        // Get token stats
                        const inputTokens = orgTokenStats.input_tokens || 0;
                        const outputTokens = orgTokenStats.output_tokens || 0;
                        const formattedInput = formatNumber(inputTokens);
                        const formattedOutput = formatNumber(outputTokens);
                        const tokenDisplay = inputTokens > 0 || outputTokens > 0 
                            ? `${formattedInput}+${formattedOutput}` 
                            : '0';
                        
                        return `
                            <div style="display:flex;align-items:center;gap:1rem;padding:0.75rem;border-bottom:1px solid #e2e8f0;transition:background 0.2s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='transparent'">
                                <div style="min-width:50px;text-align:center;font-weight:700;padding:0.5rem;border-radius:8px;${rankStyle}">
                                    ${rankBadge}
                                </div>
                                <div style="flex:1;font-weight:500;">
                                    ${org}
                                </div>
                                <div style="font-weight:700;color:#10b981;font-size:1.1rem;min-width:120px;text-align:right;">
                                    ${tokenDisplay} <span style="font-size:0.85rem;font-weight:400;color:#64748b;"><span class="lang-zh">Token</span><span class="lang-en">tokens</span></span>
                                </div>
                                <div style="font-weight:500;color:#64748b;font-size:0.95rem;min-width:80px;text-align:right;">
                                    ${userCount} <span style="font-size:0.85rem;font-weight:400;"><span class="lang-zh">ç”¨æˆ·</span><span class="lang-en">users</span></span>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                // Apply current language to newly injected content
                applyCurrentLanguage();
            } catch (error) {
                showAlert('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥ Failed to load stats', 'error');
            }
        }

        // Token Statistics
        async function loadTokenStats() {
            try {
                const response = await auth.fetch('/api/auth/admin/token-stats');
                const data = await response.json();

                // Display stats cards
                const today = data.today || { input_tokens: 0, output_tokens: 0, total_tokens: 0 };
                const week = data.past_week || { input_tokens: 0, output_tokens: 0, total_tokens: 0 };
                const month = data.past_month || { input_tokens: 0, output_tokens: 0, total_tokens: 0 };
                const total = data.total || { input_tokens: 0, output_tokens: 0, total_tokens: 0 };

                // Format and display today
                const todayInput = formatNumber(today.input_tokens || 0);
                const todayOutput = formatNumber(today.output_tokens || 0);
                document.getElementById('token-today').textContent = `${todayInput}+${todayOutput}`;

                // Format and display week
                const weekInput = formatNumber(week.input_tokens || 0);
                const weekOutput = formatNumber(week.output_tokens || 0);
                document.getElementById('token-week').textContent = `${weekInput}+${weekOutput}`;

                // Format and display month
                const monthInput = formatNumber(month.input_tokens || 0);
                const monthOutput = formatNumber(month.output_tokens || 0);
                document.getElementById('token-month').textContent = `${monthInput}+${monthOutput}`;

                // Format and display total
                const totalInput = formatNumber(total.input_tokens || 0);
                const totalOutput = formatNumber(total.output_tokens || 0);
                document.getElementById('token-total').textContent = `${totalInput}+${totalOutput}`;

                // Display top 10 users with table layout
                const usersList = document.getElementById('token-users-list');
                const topUsers = data.top_users || [];

                if (topUsers.length === 0) {
                    usersList.innerHTML = '<div style="color:#64748b;text-align:center;padding:2rem;"><span class="lang-zh">æš‚æ— ç”¨æˆ·æ•°æ®</span><span class="lang-en">No user data yet</span></div>';
                } else {
                    // Table header
                    let tableHtml = `
                        <table style="width:100%;border-collapse:collapse;">
                            <thead>
                                <tr style="background:#f8fafc;border-bottom:2px solid #e2e8f0;">
                                    <th style="padding:0.75rem;text-align:center;font-weight:600;color:#475569;width:60px;"><span class="lang-zh">æ’å</span><span class="lang-en">Rank</span></th>
                                    <th style="padding:0.75rem;text-align:left;font-weight:600;color:#475569;"><span class="lang-zh">å§“å</span><span class="lang-en">Name</span></th>
                                    <th style="padding:0.75rem;text-align:left;font-weight:600;color:#475569;width:130px;"><span class="lang-zh">æ‰‹æœºå·</span><span class="lang-en">Phone</span></th>
                                    <th style="padding:0.75rem;text-align:left;font-weight:600;color:#475569;"><span class="lang-zh">å­¦æ ¡</span><span class="lang-en">School</span></th>
                                    <th style="padding:0.75rem;text-align:right;font-weight:600;color:#475569;width:150px;"><span class="lang-zh">Tokenä½¿ç”¨é‡</span><span class="lang-en">Token Usage</span></th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    tableHtml += topUsers.map((user, index) => {
                        const rank = index + 1;
                        let rankBadge = '';
                        let rankStyle = '';
                        
                        if (rank === 1) {
                            rankBadge = 'ğŸ¥‡';
                            rankStyle = 'background:linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);color:#000;';
                        } else if (rank === 2) {
                            rankBadge = 'ğŸ¥ˆ';
                            rankStyle = 'background:linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%);color:#000;';
                        } else if (rank === 3) {
                            rankBadge = 'ğŸ¥‰';
                            rankStyle = 'background:linear-gradient(135deg, #cd7f32 0%, #d4a574 100%);color:#000;';
                        } else {
                            rankBadge = `#${rank}`;
                            rankStyle = 'background:#f1f5f9;color:#64748b;';
                        }
                        
                        const inputTokens = user.input_tokens || 0;
                        const outputTokens = user.output_tokens || 0;
                        const formattedInput = formatNumber(inputTokens);
                        const formattedOutput = formatNumber(outputTokens);
                        const tokenDisplay = inputTokens > 0 || outputTokens > 0 
                            ? `${formattedInput}+${formattedOutput}` 
                            : '0';
                        const maskedPhoneDisplay = maskPhone(user.phone);
                        const orgName = user.organization_name || '';
                        const displayName = user.name || maskedPhoneDisplay;
                        
                        return `
                            <tr style="border-bottom:1px solid #e2e8f0;transition:background 0.2s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='transparent'">
                                <td style="padding:0.75rem;text-align:center;">
                                    <span style="display:inline-block;min-width:40px;text-align:center;font-weight:700;padding:0.35rem 0.5rem;border-radius:6px;${rankStyle}">${rankBadge}</span>
                                </td>
                                <td style="padding:0.75rem;font-weight:500;">${displayName}</td>
                                <td style="padding:0.75rem;font-size:0.875rem;color:#64748b;">${maskedPhoneDisplay}</td>
                                <td style="padding:0.75rem;font-size:0.875rem;">
                                    ${orgName ? `<span style="background:#eef2ff;color:#6366f1;padding:0.25rem 0.5rem;border-radius:4px;">${orgName}</span>` : '<span style="color:#94a3b8;">-</span>'}
                                </td>
                                <td style="padding:0.75rem;text-align:right;font-weight:700;color:#10b981;font-size:1.05rem;">
                                    ${tokenDisplay}
                                </td>
                            </tr>
                        `;
                    }).join('');
                    
                    tableHtml += '</tbody></table>';
                    usersList.innerHTML = tableHtml;
                }
                
                // Apply current language to newly injected content
                applyCurrentLanguage();
            } catch (error) {
                showAlert('åŠ è½½Tokenç»Ÿè®¡å¤±è´¥ Failed to load token stats', 'error');
                console.error('Token stats error:', error);
            }
        }

        // Schools
        async function loadSchools() {
            document.getElementById('schools-loading').style.display = 'block';
            document.getElementById('schools-table').style.display = 'none';

            try {
                const response = await auth.fetch('/api/auth/admin/organizations');
                schools = await response.json();

                const tbody = document.getElementById('schools-tbody');
                tbody.innerHTML = schools.map(school => {
                    const now = new Date();
                    const expiresAt = school.expires_at ? new Date(school.expires_at) : null;
                    const isExpired = expiresAt && expiresAt < now;
                    const isActive = school.is_active !== false;
                    
                    // Get token stats for this school
                    const tokenStats = school.token_stats || { input_tokens: 0, output_tokens: 0, total_tokens: 0 };
                    const inputTokens = tokenStats.input_tokens || 0;
                    const outputTokens = tokenStats.output_tokens || 0;
                    
                    // Format token numbers (using global formatNumber function)
                    const formattedInput = formatNumber(inputTokens);
                    const formattedOutput = formatNumber(outputTokens);
                    const tokenDisplay = inputTokens > 0 || outputTokens > 0 
                        ? `${formattedInput}+${formattedOutput}` 
                        : '0';
                    
                    return `
                        <tr style="${!isActive || isExpired ? 'background:#fee;' : ''}">
                            <td>${school.name}</td>
                            <td>
                                <span class="badge badge-success">${school.invitation_code}</span>
                                <button class="btn btn-sm" 
                                        onclick="copySchoolInviteInfo('${school.invitation_code}')" 
                                        title="å¤åˆ¶åˆ†äº«ä¿¡æ¯"
                                        style="background:transparent;border:none;padding:0.25rem 0.5rem;cursor:pointer;font-size:1.1rem;">
                                    ğŸ“¤
                                </button>
                            </td>
                            <td style="font-weight:700;color:#10b981;">
                                ${tokenDisplay} <span style="font-size:0.85rem;font-weight:400;color:#64748b;"><span class="lang-zh">Token</span><span class="lang-en">tokens</span></span>
                            </td>
                            <td>
                                ${!isActive ? 
                                    '<span class="badge badge-danger">ğŸ”’ <span class="lang-zh">é”å®š</span><span class="lang-en">Locked</span><span class="lang-az">KilidlÉ™nib</span></span>' : 
                                    isExpired ? 
                                    '<span class="badge badge-danger">â° <span class="lang-zh">å·²è¿‡æœŸ</span><span class="lang-en">Expired</span><span class="lang-az">MÃ¼ddÉ™ti Bitib</span></span>' :
                                    '<span class="badge badge-success">âœ… <span class="lang-zh">æ­£å¸¸</span><span class="lang-en">Active</span><span class="lang-az">Aktiv</span></span>'
                                }
                            </td>
                            <td>${school.user_count} <span class="lang-zh">ç”¨æˆ·</span><span class="lang-en">users</span><span class="lang-az">istifadÉ™Ã§i</span></td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick="editSchool(${school.id})"><span class="lang-zh">ç¼–è¾‘</span><span class="lang-en">Edit</span><span class="lang-az">RedaktÉ™</span></button>
                                <button class="btn btn-danger btn-sm" onclick="deleteSchool(${school.id}, '${school.code}')"><span class="lang-zh">åˆ é™¤</span><span class="lang-en">Delete</span><span class="lang-az">Sil</span></button>
                            </td>
                        </tr>
                    `;
                }).join('');

                document.getElementById('schools-loading').style.display = 'none';
                document.getElementById('schools-table').style.display = 'table';
            } catch (error) {
                showAlert('åŠ è½½å­¦æ ¡åˆ—è¡¨å¤±è´¥ Failed to load schools', 'error');
            }
        }

        async function createSchool() {
            const data = {
                code: document.getElementById('new-school-code').value,
                name: document.getElementById('new-school-name').value
            };

            if (!data.code || !data.name) {
                showAlert('è¯·å¡«å†™å¿…å¡«å­—æ®µ Please fill required fields', 'error');
                return;
            }

            try {
                await auth.fetch('/api/auth/admin/organizations', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                showAlert('å­¦æ ¡åˆ›å»ºæˆåŠŸ School created successfully', 'success');
                closeModal('create-school-modal');
                loadSchools();
                
                // Clear form
                document.getElementById('new-school-code').value = '';
                document.getElementById('new-school-name').value = '';
                // Invitation code is generated on the server
            } catch (error) {
                showAlert('åˆ›å»ºå¤±è´¥ Creation failed: ' + error.message, 'error');
            }
        }

        function editSchool(id) {
            const school = schools.find(s => s.id === id);
            if (!school) return;

            document.getElementById('edit-school-id').value = school.id;
            document.getElementById('edit-school-code').value = school.code;
            document.getElementById('edit-school-name').value = school.name;
            document.getElementById('edit-school-invite').value = school.invitation_code;
            
            // Set expiration date (convert from ISO to YYYY-MM-DD format for date input)
            if (school.expires_at) {
                const date = new Date(school.expires_at);
                document.getElementById('edit-school-expires').value = date.toISOString().split('T')[0];
            } else {
                document.getElementById('edit-school-expires').value = '';
            }
            
            // Set active status
            document.getElementById('edit-school-active').value = school.is_active !== false ? 'true' : 'false';
            
            document.getElementById('edit-school-modal').classList.add('show');
        }

        function regenerateInviteCode() {
            const name = document.getElementById('edit-school-name').value;
            const code = document.getElementById('edit-school-code').value;
            const prefix = (name || code || '').replace(/[^A-Za-z]/g, '').toUpperCase().slice(0, 4).padEnd(4, 'X');
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let suffix = '';
            for (let i = 0; i < 5; i++) {
                suffix += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('edit-school-invite').value = `${prefix}-${suffix}`;
        }

        async function updateSchool() {
            const id = document.getElementById('edit-school-id').value;
            const expiresValue = document.getElementById('edit-school-expires').value;
            
            const data = {
                code: document.getElementById('edit-school-code').value,
                name: document.getElementById('edit-school-name').value,
                invitation_code: document.getElementById('edit-school-invite').value,
                expires_at: expiresValue ? expiresValue : null,  // Convert to null if empty
                is_active: document.getElementById('edit-school-active').value === 'true'
            };

            try {
                await auth.fetch(`/api/auth/admin/organizations/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                showAlert('å­¦æ ¡æ›´æ–°æˆåŠŸ School updated successfully', 'success');
                closeModal('edit-school-modal');
                loadSchools();
            } catch (error) {
                showAlert('æ›´æ–°å¤±è´¥ Update failed: ' + error.message, 'error');
            }
        }

        async function deleteSchool(id, code) {
            if (!confirm(`ç¡®å®šåˆ é™¤å­¦æ ¡ ${code}ï¼Ÿ\nAre you sure to delete school ${code}?`)) return;

            try {
                await auth.fetch(`/api/auth/admin/organizations/${id}`, {
                    method: 'DELETE'
                });

                showAlert('å­¦æ ¡åˆ é™¤æˆåŠŸ School deleted successfully', 'success');
                loadSchools();
            } catch (error) {
                showAlert('åˆ é™¤å¤±è´¥ Delete failed: ' + error.message, 'error');
            }
        }

        function copySchoolInviteInfo(invitationCode) {
            const shareText = `å°Šæ•¬çš„æ ¡é¢†å¯¼ï¼Œæ‚¨å¥½ï¼
è¯šæŒšé‚€è¯·æ‚¨ä¸å­¦æ ¡å›¢é˜Ÿä½“éªŒ MindGraph â€”â€” æˆ‘ä»¬å€¾åŠ›æ‰“é€ çš„AIæ€ç»´å›¾ç¤ºç”Ÿæˆè½¯ä»¶ï¼Œè‡´åŠ›äºå¼€å‘æ€ç»´æ•™å­¦ä¿¡æ¯åŒ–å¹³å°ã€‚
è´µæ ¡çš„ä¸“å±é‚€è¯·ç æ˜¯ï¼š${invitationCode}
è¯·æ‚¨è®¿é—® mg.mingspringedu.com å®Œæˆæ³¨å†Œï¼Œå¼€å¯é«˜æ•ˆã€ç›´è§‚çš„æ€ç»´å¯è§†åŒ–åä½œã€‚
æœŸå¾…èƒ½ä¸ºè´µæ ¡çš„æ•™è‚²åˆ›æ–°å¢æ·»ä¸€ä»½åŠ›é‡ã€‚`;
            
            // Set the text in the modal
            document.getElementById('share-invite-text').value = shareText;
            
            // Show the modal
            openModal('share-invite-modal');
        }
        
        async function selectAndCopyShareText(button) {
            const textarea = document.getElementById('share-invite-text');
            const text = textarea.value;
            
            // Select the text
            textarea.select();
            textarea.setSelectionRange(0, 99999); // For mobile devices
            
            // Copy to clipboard
            try {
                await navigator.clipboard.writeText(text);
                // Show feedback
                const originalText = button.innerHTML;
                button.innerHTML = 'âœ… <span class="lang-zh">å·²å¤åˆ¶ï¼</span><span class="lang-en">Copied!</span>';
                button.style.background = '#10b981';
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.style.background = '';
                }, 2000);
            } catch (err) {
                // Fallback for older browsers
                try {
                    document.execCommand('copy');
                    const originalText = button.innerHTML;
                    button.innerHTML = 'âœ… <span class="lang-zh">å·²å¤åˆ¶ï¼</span><span class="lang-en">Copied!</span>';
                    button.style.background = '#10b981';
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.style.background = '';
                    }, 2000);
                } catch (fallbackErr) {
                    alert('æ— æ³•å¤åˆ¶ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¹¶å¤åˆ¶æ–‡æœ¬');
                }
            }
        }

        // Users
        async function loadUsers(page = 1) {
            document.getElementById('users-loading').style.display = 'block';
            document.getElementById('users-table').style.display = 'none';
            document.getElementById('users-pagination').style.display = 'none';

            try {
                // Build query parameters
                const search = document.getElementById('user-search').value.trim();
                const orgId = document.getElementById('user-org-filter').value;
                
                let url = `/api/auth/admin/users?page=${page}&page_size=${usersPageSize}`;
                if (search) url += `&search=${encodeURIComponent(search)}`;
                if (orgId) url += `&organization_id=${orgId}`;
                
                const response = await auth.fetch(url);
                const data = await response.json();
                
                users = data.users;
                usersCurrentPage = data.pagination.page;
                usersTotalPages = data.pagination.total_pages;
                usersTotal = data.pagination.total;

                const tbody = document.getElementById('users-tbody');
                
                // Format number helper (using global formatNumber function)
                tbody.innerHTML = users.map(user => {
                    const isLocked = user.locked_until && new Date(user.locked_until) > new Date();
                    
                    // Get token stats for this user
                    const tokenStats = user.token_stats || { input_tokens: 0, output_tokens: 0, total_tokens: 0 };
                    const inputTokens = tokenStats.input_tokens || 0;
                    const outputTokens = tokenStats.output_tokens || 0;
                    const formattedInput = formatNumber(inputTokens);
                    const formattedOutput = formatNumber(outputTokens);
                    const tokenDisplay = inputTokens > 0 || outputTokens > 0 
                        ? `${formattedInput}+${formattedOutput}` 
                        : '0';
                    
                    return `
                        <tr>
                            <td>${user.phone}</td>
                            <td>${user.name || '-'}</td>
                            <td>${user.organization_name || '-'}</td>
                            <td style="font-weight:700;color:#10b981;">
                                ${tokenDisplay} <span style="font-size:0.85rem;font-weight:400;color:#64748b;"><span class="lang-zh">Token</span><span class="lang-en">tokens</span></span>
                            </td>
                            <td style="color:#64748b;">
                                ${user.created_at ? (() => {
                                    const date = new Date(user.created_at);
                                    const year = date.getFullYear();
                                    const month = String(date.getMonth() + 1).padStart(2, '0');
                                    const day = String(date.getDate()).padStart(2, '0');
                                    return `${year}-${month}-${day}`;
                                })() : '-'}
                            </td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick="showEditUserModal(${user.id})" title="Edit User"><span class="lang-zh">ç¼–è¾‘</span><span class="lang-en">Edit</span><span class="lang-az">RedaktÉ™</span></button>
                                <button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id}, '${user.phone}')" title="Delete User"><span class="lang-zh">åˆ é™¤</span><span class="lang-en">Delete</span><span class="lang-az">Sil</span></button>
                                ${isLocked ? 
                                    `<button class="btn btn-success btn-sm" onclick="unlockUser(${user.id}, '${user.phone}')" title="Unlock Account">ğŸ”“ <span class="lang-zh">è§£é”</span><span class="lang-en">Unlock</span><span class="lang-az">Kilidi AÃ§</span></button>` : 
                                    ''
                                }
                            </td>
                        </tr>
                    `;
                }).join('');

                // Update pagination info
                updateUsersPagination();

                document.getElementById('users-loading').style.display = 'none';
                document.getElementById('users-table').style.display = 'table';
                document.getElementById('users-pagination').style.display = 'block';
            } catch (error) {
                showAlert('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥ Failed to load users', 'error');
                console.error(error);
            }
        }
        
        function updateUsersPagination() {
            // Update page info
            const start = (usersCurrentPage - 1) * usersPageSize + 1;
            const end = Math.min(usersCurrentPage * usersPageSize, usersTotal);
            document.getElementById('users-page-info').innerHTML = `
                <span class="lang-zh">æ˜¾ç¤º ${start}-${end} å…± ${usersTotal} æ¡</span>
                <span class="lang-en">Showing ${start}-${end} of ${usersTotal}</span>
            `;
            
            // Update prev/next buttons
            document.getElementById('users-prev-btn').disabled = usersCurrentPage === 1;
            document.getElementById('users-next-btn').disabled = usersCurrentPage === usersTotalPages;
            
            // Generate page numbers (show max 5 pages)
            const pageNumbers = document.getElementById('users-page-numbers');
            pageNumbers.innerHTML = '';
            
            let startPage = Math.max(1, usersCurrentPage - 2);
            let endPage = Math.min(usersTotalPages, startPage + 4);
            
            // Adjust start if we're near the end
            if (endPage - startPage < 4) {
                startPage = Math.max(1, endPage - 4);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const btn = document.createElement('button');
                btn.className = `btn btn-sm ${i === usersCurrentPage ? 'btn-primary' : 'btn-secondary'}`;
                btn.textContent = i;
                btn.onclick = () => gotoUsersPage(i);
                pageNumbers.appendChild(btn);
            }
        }
        
        function filterUsers() {
            usersCurrentPage = 1; // Reset to page 1 when filtering
            loadUsers(1);
        }
        
        function clearUserFilters() {
            document.getElementById('user-search').value = '';
            document.getElementById('user-org-filter').value = '';
            filterUsers();
        }
        
        function previousUsersPage() {
            if (usersCurrentPage > 1) {
                loadUsers(usersCurrentPage - 1);
            }
        }
        
        function nextUsersPage() {
            if (usersCurrentPage < usersTotalPages) {
                loadUsers(usersCurrentPage + 1);
            }
        }
        
        function gotoUsersPage(page) {
            loadUsers(page);
        }
        
        // Load organizations into filter dropdown
        async function loadUserFilters() {
            try {
                const response = await auth.fetch('/api/auth/admin/organizations');
                const orgs = await response.json();
                
                const select = document.getElementById('user-org-filter');
                const currentValue = select.value;
                
                select.innerHTML = '<option value=""><span class="lang-zh">å…¨éƒ¨å­¦æ ¡</span><span class="lang-en">All Schools</span></option>' + 
                    orgs.map(org => `<option value="${org.id}">${org.code} - ${org.name}</option>`).join('');
                
                select.value = currentValue; // Restore selection if any
                
                // Apply current language to newly injected content
                applyCurrentLanguage();
            } catch (error) {
                console.error('Failed to load organizations for filter:', error);
            }
        }

        async function showEditUserModal(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) {
                showAlert('User not found', 'error');
                return;
            }

            // Set user data (use real phone for editing)
            document.getElementById('edit-user-id').value = user.id;
            document.getElementById('edit-user-phone').value = user.phone_real || user.phone;
            document.getElementById('edit-user-name').value = user.name || '';
            // Reset password field to default
            document.getElementById('edit-user-reset-password').value = '12345678';

            // Load organizations for dropdown
            try {
                const response = await auth.fetch('/api/auth/organizations');
                const orgs = await response.json();
                
                const select = document.getElementById('edit-user-org');
                select.innerHTML = orgs.map(org => {
                    const selected = org.id === user.organization_id ? 'selected' : '';
                    return `<option value="${org.id}" ${selected}>${org.code} - ${org.name}</option>`;
                }).join('');
            } catch (error) {
                showAlert('Failed to load organizations', 'error');
                return;
            }

            openModal('edit-user-modal');
        }

        async function updateUser() {
            const userId = document.getElementById('edit-user-id').value;
            const phone = document.getElementById('edit-user-phone').value.trim();
            const name = document.getElementById('edit-user-name').value.trim();
            const orgId = parseInt(document.getElementById('edit-user-org').value);

            if (!phone || !name || !orgId) {
                showAlert('æ‰€æœ‰å­—æ®µå¿…å¡« All fields required', 'error');
                return;
            }

            // Validate phone
            if (!/^1\d{10}$/.test(phone)) {
                showAlert('Invalid phone number! Must be 11 digits starting with 1', 'error');
                return;
            }

            // Validate name
            if (/\d/.test(name)) {
                showAlert('Name cannot contain numbers!', 'error');
                return;
            }

            try {
                await auth.fetch(`/api/auth/admin/users/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone: phone,
                        name: name,
                        organization_id: orgId
                    })
                });

                showAlert('ç”¨æˆ·æ›´æ–°æˆåŠŸ User updated successfully', 'success');
                closeModal('edit-user-modal');
                loadUsers();
            } catch (error) {
                showAlert('æ›´æ–°å¤±è´¥ Update failed: ' + error.message, 'error');
            }
        }

        async function deleteUser(userId, phone) {
            if (!confirm(`âš ï¸ ç¡®å®šåˆ é™¤ç”¨æˆ· ${phone}ï¼Ÿ\nâš ï¸ Are you sure to delete user ${phone}?\n\nThis action cannot be undone!`)) {
                return;
            }

            try {
                await auth.fetch(`/api/auth/admin/users/${userId}`, {
                    method: 'DELETE'
                });

                showAlert('ç”¨æˆ·åˆ é™¤æˆåŠŸ User deleted successfully', 'success');
                loadUsers();
            } catch (error) {
                showAlert('åˆ é™¤å¤±è´¥ Delete failed: ' + error.message, 'error');
            }
        }

        async function unlockUser(id, phone) {
            if (!confirm(`ç¡®å®šè§£é”ç”¨æˆ· ${phone}ï¼Ÿ\nUnlock user ${phone}?`)) return;

            try {
                await auth.fetch(`/api/auth/admin/users/${id}/unlock`, {
                    method: 'PUT'
                });

                showAlert('ç”¨æˆ·è§£é”æˆåŠŸ User unlocked successfully', 'success');
                loadUsers();
            } catch (error) {
                showAlert('è§£é”å¤±è´¥ Unlock failed: ' + error.message, 'error');
            }
        }
        
        async function resetPasswordFromModal() {
            const userId = document.getElementById('edit-user-id').value;
            const phone = document.getElementById('edit-user-phone').value;
            const passwordInput = document.getElementById('edit-user-reset-password');
            const newPassword = passwordInput.value.trim() || '12345678';
            
            const confirmMessage = newPassword === '12345678' 
                ? `âš ï¸ ç¡®å®šé‡ç½®è¯¥ç”¨æˆ·çš„å¯†ç ä¸º '12345678'ï¼Ÿ\nâš ï¸ Reset this user's password to '12345678'?\n\nUser: ${phone}\n\nThe user will need to login again with the new password.`
                : `âš ï¸ ç¡®å®šé‡ç½®è¯¥ç”¨æˆ·çš„å¯†ç ï¼Ÿ\nâš ï¸ Reset this user's password?\n\nUser: ${phone}\n\nNew password: ${'*'.repeat(newPassword.length)}\n\nThe user will need to login again with the new password.`;
            
            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                const requestBody = { password: newPassword };
                await auth.fetch(`/api/auth/admin/users/${userId}/reset-password`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const successMessage = newPassword === '12345678'
                    ? 'å¯†ç é‡ç½®æˆåŠŸ (é‡ç½®ä¸ºé»˜è®¤å¯†ç  "12345678") Password reset successfully (to default "12345678")'
                    : `å¯†ç é‡ç½®æˆåŠŸ Password reset successfully`;
                showAlert(successMessage, 'success');
                closeModal('edit-user-modal');
                loadUsers();
            } catch (error) {
                showAlert('å¯†ç é‡ç½®å¤±è´¥ Password reset failed: ' + error.message, 'error');
            }
        }

        // Enhanced Settings Management
        async function loadEnvSettings() {
            document.getElementById('settings-loading').style.display = 'block';
            document.getElementById('settings-form').style.display = 'none';

            try {
                const response = await auth.fetch('/api/auth/admin/env/settings');
                const data = await response.json();
                const settings = data.settings;

                // Populate all form fields dynamically
                for (const key in settings) {
                    const element = document.getElementById(`env-${key}`);
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = settings[key] === 'True' || settings[key] === 'true';
                        } else {
                            element.value = settings[key] || '';
                        }
                    }
                }

                document.getElementById('settings-loading').style.display = 'none';
                document.getElementById('settings-form').style.display = 'block';
            } catch (error) {
                console.error('Failed to load settings:', error);
                showAlert('Failed to load settings: ' + error.message, 'error');
            }
        }

        async function saveEnvSettings() {
            // Collect all settings from form
            const data = {};
            const inputs = document.querySelectorAll('[id^="env-"]');
            
            inputs.forEach(input => {
                const key = input.id.replace('env-', '');
                if (input.type === 'checkbox') {
                    data[key] = input.checked ? 'True' : 'False';
                } else {
                    data[key] = input.value;
                }
            });

            try {
                const response = await auth.fetch('/api/auth/admin/env/settings', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                showAlert(`${result.message} - ${result.warning}`, 'warning');
                
                // Reload settings to show updated values
                setTimeout(() => loadEnvSettings(), 1000);
            } catch (error) {
                console.error('Failed to save settings:', error);
                showAlert('Save failed: ' + error.message, 'error');
            }
        }

        async function validateEnvSettings() {
            // Collect all settings from form
            const data = {};
            const inputs = document.querySelectorAll('[id^="env-"]');
            
            inputs.forEach(input => {
                const key = input.id.replace('env-', '');
                if (input.type === 'checkbox') {
                    data[key] = input.checked ? 'True' : 'False';
                } else {
                    data[key] = input.value;
                }
            });

            try {
                const response = await auth.fetch('/api/auth/admin/env/validate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (result.is_valid) {
                    showAlert('Validation passed! All settings are valid.', 'success');
                } else {
                    showAlert(`Validation errors: ${result.errors.join(', ')}`, 'error');
                }
            } catch (error) {
                console.error('Validation failed:', error);
                showAlert('Validation failed: ' + error.message, 'error');
            }
        }

        async function showBackupListModal() {
            document.getElementById('backup-list-modal').classList.add('show');
            document.getElementById('backup-list-loading').style.display = 'block';
            document.getElementById('backup-list-content').style.display = 'none';

            try {
                const response = await auth.fetch('/api/auth/admin/env/backups');
                const backups = await response.json();

                const tbody = document.getElementById('backup-list-tbody');
                const noBackupsMsg = document.getElementById('no-backups-message');

                if (backups.length === 0) {
                    tbody.innerHTML = '';
                    noBackupsMsg.style.display = 'block';
                } else {
                    noBackupsMsg.style.display = 'none';
                    tbody.innerHTML = backups.map(backup => `
                        <tr>
                            <td><code style="font-size:0.85rem;">${backup.filename}</code></td>
                            <td>${backup.timestamp}</td>
                            <td>${(backup.size_bytes / 1024).toFixed(1)} KB</td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick="restoreEnvBackup('${backup.filename}')">
                                    Restore
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }

                document.getElementById('backup-list-loading').style.display = 'none';
                document.getElementById('backup-list-content').style.display = 'block';
            } catch (error) {
                console.error('Failed to load backups:', error);
                showAlert('Failed to load backups: ' + error.message, 'error');
                closeModal('backup-list-modal');
            }
        }

        async function restoreEnvBackup(filename) {
            if (!confirm(`Restore .env from backup: ${filename}?\n\nCurrent .env will be backed up before restoration.`)) {
                return;
            }

            try {
                const response = await auth.fetch(`/api/auth/admin/env/restore?backup_filename=${encodeURIComponent(filename)}`, {
                    method: 'POST'
                });

                const result = await response.json();
                showAlert(`${result.message} - ${result.warning}`, 'success');
                
                // Close modal and reload settings
                closeModal('backup-list-modal');
                setTimeout(() => loadEnvSettings(), 1000);
            } catch (error) {
                console.error('Failed to restore backup:', error);
                showAlert('Restore failed: ' + error.message, 'error');
            }
        }

        function toggleCategory(categoryId) {
            const content = document.getElementById(`${categoryId}-content`);
            const icon = document.getElementById(`${categoryId}-icon`);
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                icon.textContent = 'â–¼';
            } else {
                content.classList.add('collapsed');
                icon.textContent = 'â–¶';
            }
        }

        // API Keys
        let apiKeys = [];

        async function loadAPIKeys() {
            document.getElementById('apikeys-loading').style.display = 'block';
            document.getElementById('apikeys-table').style.display = 'none';

            try {
                const response = await auth.fetch('/api/auth/admin/api_keys');
                apiKeys = await response.json();

                const tbody = document.getElementById('apikeys-tbody');
                tbody.innerHTML = apiKeys.map(key => {
                    const isExpired = key.expires_at && new Date(key.expires_at) < new Date();
                    const usagePercent = key.usage_percentage || 0;
                    const quotaText = key.quota_limit ? `${key.usage_count.toLocaleString()} / ${key.quota_limit.toLocaleString()}` : `${key.usage_count.toLocaleString()} / unlimited`;
                    
                    return `
                        <tr>
                            <td>
                                <strong>${key.name}</strong>
                                ${key.description ? `<br><small style="color:#64748b;">${key.description}</small>` : ''}
                            </td>
                            <td>
                                <code style="font-size:0.75rem;background:#f1f5f9;padding:0.25rem 0.5rem;border-radius:4px;" onclick="copyToClipboard('${key.key}', this)">${key.key.substring(0, 20)}...${key.key.substring(key.key.length - 8)}</code>
                            </td>
                            <td>
                                ${quotaText}
                                ${key.quota_limit ? `<br><div style="background:#e2e8f0;height:6px;border-radius:3px;margin-top:4px;overflow:hidden;"><div style="background:${usagePercent > 90 ? '#ef4444' : '#667eea'};width:${Math.min(usagePercent, 100)}%;height:100%;"></div></div>` : ''}
                            </td>
                            <td>
                                ${key.is_active && !isExpired ? 
                                    '<span class="badge badge-success">âœ… <span class="lang-zh">æ¿€æ´»</span><span class="lang-en">Active</span><span class="lang-az">Aktiv</span></span>' : 
                                    isExpired ? '<span class="badge badge-danger">â° <span class="lang-zh">è¿‡æœŸ</span><span class="lang-en">Expired</span><span class="lang-az">MÃ¼ddÉ™ti Bitib</span></span>' :
                                    '<span class="badge badge-danger">âŒ <span class="lang-zh">ç¦ç”¨</span><span class="lang-en">Disabled</span><span class="lang-az">Deaktiv</span></span>'
                                }
                            </td>
                            <td><small>${new Date(key.created_at).toLocaleDateString()}</small></td>
                            <td><small>${key.last_used_at ? new Date(key.last_used_at).toLocaleString() : 'Never'}</small></td>
                            <td>
                                <button class="btn btn-sm ${key.is_active ? 'btn-secondary' : 'btn-success'}" onclick="toggleAPIKey(${key.id})">${key.is_active ? 'â¸ï¸ <span class="lang-zh">ç¦ç”¨</span><span class="lang-en">Disable</span><span class="lang-az">DeaktivlÉ™ÅŸdir</span>' : 'â–¶ï¸ <span class="lang-zh">å¯ç”¨</span><span class="lang-en">Enable</span><span class="lang-az">AktivlÉ™ÅŸdir</span>'}</button>
                                <button class="btn btn-primary btn-sm" onclick="editAPIKey(${key.id})"><span class="lang-zh">ç¼–è¾‘</span><span class="lang-en">Edit</span><span class="lang-az">RedaktÉ™</span></button>
                                <button class="btn btn-danger btn-sm" onclick="deleteAPIKey(${key.id}, '${key.name}')"><span class="lang-zh">åˆ é™¤</span><span class="lang-en">Delete</span><span class="lang-az">Sil</span></button>
                            </td>
                        </tr>
                    `;
                }).join('');

                document.getElementById('apikeys-loading').style.display = 'none';
                document.getElementById('apikeys-table').style.display = 'table';
            } catch (error) {
                showAlert('Failed to load API keys: ' + error.message, 'error');
            }
        }

        function showCreateAPIKeyModal() {
            document.getElementById('create-apikey-modal').classList.add('show');
        }

        async function createAPIKey() {
            const data = {
                name: document.getElementById('new-apikey-name').value,
                description: document.getElementById('new-apikey-description').value,
                quota_limit: document.getElementById('new-apikey-quota').value ? parseInt(document.getElementById('new-apikey-quota').value) : null,
                expires_days: document.getElementById('new-apikey-expires').value ? parseInt(document.getElementById('new-apikey-expires').value) : null
            };

            if (!data.name) {
                showAlert('Please enter a name for the API key', 'error');
                return;
            }

            try {
                const response = await auth.fetch('/api/auth/admin/api_keys', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                // Show the generated key
                document.getElementById('generated-apikey').value = result.key;
                closeModal('create-apikey-modal');
                document.getElementById('show-apikey-modal').classList.add('show');
                
                // Clear form
                document.getElementById('new-apikey-name').value = '';
                document.getElementById('new-apikey-description').value = '';
                document.getElementById('new-apikey-quota').value = '';
                document.getElementById('new-apikey-expires').value = '';
                
                showAlert(result.message, 'success');
                loadAPIKeys();
            } catch (error) {
                showAlert('Failed to create API key: ' + error.message, 'error');
            }
        }

        function copyAPIKey() {
            const apiKeyInput = document.getElementById('generated-apikey');
            apiKeyInput.select();
            navigator.clipboard.writeText(apiKeyInput.value);
            showAlert('API key copied to clipboard! ğŸ“‹', 'success');
        }

        function copyToClipboard(text, element) {
            navigator.clipboard.writeText(text);
            const originalText = element.innerHTML;
            element.innerHTML = 'âœ… Copied!';
            element.style.background = '#d1fae5';
            element.style.color = '#065f46';
            setTimeout(() => {
                element.innerHTML = originalText;
                element.style.background = '#f1f5f9';
                element.style.color = '';
            }, 2000);
        }

        function editAPIKey(id) {
            const key = apiKeys.find(k => k.id === id);
            if (!key) return;

            document.getElementById('edit-apikey-id').value = key.id;
            document.getElementById('edit-apikey-name').value = key.name;
            document.getElementById('edit-apikey-description').value = key.description || '';
            document.getElementById('edit-apikey-quota').value = key.quota_limit || '';
            document.getElementById('edit-apikey-usage').value = key.usage_count;
            
            document.getElementById('edit-apikey-modal').classList.add('show');
        }

        async function updateAPIKey() {
            const id = document.getElementById('edit-apikey-id').value;
            const data = {
                name: document.getElementById('edit-apikey-name').value,
                description: document.getElementById('edit-apikey-description').value,
                quota_limit: document.getElementById('edit-apikey-quota').value ? parseInt(document.getElementById('edit-apikey-quota').value) : null,
                usage_count: parseInt(document.getElementById('edit-apikey-usage').value)
            };

            try {
                await auth.fetch(`/api/auth/admin/api_keys/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                showAlert('API key updated successfully', 'success');
                closeModal('edit-apikey-modal');
                loadAPIKeys();
            } catch (error) {
                showAlert('Failed to update API key: ' + error.message, 'error');
            }
        }

        async function toggleAPIKey(id) {
            try {
                const response = await auth.fetch(`/api/auth/admin/api_keys/${id}/toggle`, {
                    method: 'PUT'
                });

                const result = await response.json();
                showAlert(result.message, 'success');
                loadAPIKeys();
            } catch (error) {
                showAlert('Failed to toggle API key: ' + error.message, 'error');
            }
        }

        async function deleteAPIKey(id, name) {
            if (!confirm(`âš ï¸ Delete API key "${name}"?\n\nThis action cannot be undone and will immediately revoke access.`)) return;

            try {
                const response = await auth.fetch(`/api/auth/admin/api_keys/${id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                showAlert(result.message, 'success');
                loadAPIKeys();
            } catch (error) {
                showAlert('Failed to delete API key: ' + error.message, 'error');
            }
        }

        function logout() {
            // Show confirmation message in current language only
            let confirmMessage;
            if (currentLang === 'zh') {
                confirmMessage = 'ç¡®å®šç™»å‡ºï¼Ÿ';
            } else if (currentLang === 'az') {
                confirmMessage = 'Ã‡Ä±xÄ±ÅŸ etmÉ™k istÉ™yirsiniz?';
            } else {
                confirmMessage = 'Are you sure to logout?';
            }
            
            if (confirm(confirmMessage)) {
                auth.logout();
            }
        }

        // Log Viewer Integration Functions
        function initLogViewer() {
            logViewer.init();
        }
        
        function toggleLogStream() {
            if (logViewer.eventSource) {
                logViewer.stopStreaming();
            } else {
                logViewer.startStreaming();
            }
        }
        
        // ============================================================================
        // UPDATE ANNOUNCEMENT MANAGEMENT
        // ============================================================================
        
        const announcementEditor = {
            // Execute command on Chinese editor
            execCommand(command, value = null) {
                const editor = document.getElementById('announcement-message');
                editor.focus();
                document.execCommand(command, false, value);
            },
            
            // Insert image - trigger file input
            insertImage() {
                document.getElementById('announcement-image-input').click();
            },
            
            // Handle image upload
            async handleImageUpload(input) {
                if (!input.files || !input.files[0]) return;
                
                const file = input.files[0];
                const formData = new FormData();
                formData.append('file', file);
                
                try {
                    showAlert('æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...', 'success');
                    
                    const response = await fetch('/api/admin/update-notification/upload-image', {
                        method: 'POST',
                        credentials: 'include',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.detail || 'ä¸Šä¼ å¤±è´¥');
                    }
                    
                    const data = await response.json();
                    
                    // Insert image into editor
                    const editor = document.getElementById('announcement-message');
                    editor.focus();
                    document.execCommand('insertHTML', false, `<img src="${data.url}" alt="å…¬å‘Šå›¾ç‰‡" style="max-width:100%;">`);
                    
                    showAlert('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ', 'success');
                    
                } catch (error) {
                    console.error('Image upload failed:', error);
                    showAlert('å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
                }
                
                // Clear input
                input.value = '';
            },
            
            // Toggle emoji picker
            toggleEmojiPicker() {
                const picker = document.getElementById('emoji-picker');
                picker.style.display = picker.style.display === 'none' ? 'block' : 'none';
            },
            
            // Insert emoji
            insertEmoji(emoji) {
                const editor = document.getElementById('announcement-message');
                editor.focus();
                document.execCommand('insertText', false, emoji);
                document.getElementById('emoji-picker').style.display = 'none';
            },
            
            // Switch emoji tab
            switchEmojiTab(tab) {
                // Hide all grids
                document.querySelectorAll('.emoji-grid').forEach(g => g.style.display = 'none');
                // Show selected grid
                document.getElementById('emoji-grid-' + tab).style.display = 'grid';
                // Update tab buttons
                document.querySelectorAll('.emoji-tab').forEach(t => t.classList.remove('active'));
                event.target.classList.add('active');
            }
        };
        
        // Close emoji picker when clicking outside
        document.addEventListener('click', function(e) {
            const picker = document.getElementById('emoji-picker');
            const wrapper = e.target.closest('.emoji-picker-wrapper');
            if (!wrapper && picker) {
                picker.style.display = 'none';
            }
        });
        
        async function loadAnnouncementConfig() {
            const loading = document.getElementById('announcement-loading');
            const form = document.getElementById('announcement-form');
            
            loading.style.display = 'block';
            form.style.display = 'none';
            
            try {
                const response = await fetch('/api/admin/update-notification', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('åŠ è½½å…¬å‘Šé…ç½®å¤±è´¥');
                }
                
                const data = await response.json();
                
                // Populate form fields
                document.getElementById('announcement-enabled').checked = data.enabled;
                document.getElementById('announcement-version').value = data.version || '';
                document.getElementById('announcement-title').value = data.title || '';
                document.getElementById('announcement-message').innerHTML = data.message || '';
                
                loading.style.display = 'none';
                form.style.display = 'block';
                
            } catch (error) {
                console.error('Failed to load announcement config:', error);
                showAlert('åŠ è½½å…¬å‘Šé…ç½®å¤±è´¥: ' + error.message, 'error');
                loading.style.display = 'none';
            }
        }
        
        // Preview announcement modal
        function previewAnnouncement() {
            const title = document.getElementById('announcement-title').value.trim() || 'ç³»ç»Ÿæ›´æ–°';
            const version = document.getElementById('announcement-version').value.trim();
            const message = document.getElementById('announcement-message').innerHTML.trim();
            
            // Create preview modal
            const previewOverlay = document.createElement('div');
            previewOverlay.id = 'announcement-preview-overlay';
            previewOverlay.innerHTML = `
                <style>
                    #announcement-preview-overlay {
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.7);
                        backdrop-filter: blur(8px);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 10000;
                        animation: fadeIn 0.3s ease;
                    }
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    .preview-modal {
                        position: relative;
                        background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%);
                        border-radius: 20px;
                        padding: 32px;
                        max-width: 500px;
                        width: 90%;
                        max-height: 80vh;
                        overflow-y: auto;
                        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5),
                                    0 0 0 1px rgba(255, 255, 255, 0.1),
                                    inset 0 1px 0 rgba(255, 255, 255, 0.1);
                        animation: slideUp 0.3s ease;
                    }
                    @keyframes slideUp {
                        from { transform: translateY(20px) scale(0.95); opacity: 0; }
                        to { transform: translateY(0) scale(1); opacity: 1; }
                    }
                    .preview-badge {
                        position: absolute;
                        top: -12px;
                        left: 50%;
                        transform: translateX(-50%);
                        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                        color: white;
                        padding: 4px 16px;
                        border-radius: 20px;
                        font-size: 12px;
                        font-weight: 600;
                        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
                    }
                    .preview-close {
                        position: absolute;
                        top: 16px;
                        right: 16px;
                        width: 36px;
                        height: 36px;
                        border: none;
                        background: rgba(255, 255, 255, 0.1);
                        border-radius: 10px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        transition: all 0.2s;
                    }
                    .preview-close:hover {
                        background: rgba(255, 255, 255, 0.2);
                        transform: scale(1.05);
                    }
                    .preview-close svg {
                        stroke: #94a3b8;
                    }
                    .preview-close:hover svg {
                        stroke: #ffffff;
                    }
                    .preview-header {
                        text-align: center;
                        margin-bottom: 24px;
                        padding-top: 8px;
                    }
                    .preview-icon {
                        width: 64px;
                        height: 64px;
                        margin: 0 auto 16px;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        border-radius: 16px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
                    }
                    .preview-icon svg {
                        stroke: white;
                    }
                    .preview-title {
                        color: #ffffff;
                        font-size: 24px;
                        font-weight: 700;
                        margin: 0 0 8px 0;
                    }
                    .preview-version {
                        display: inline-block;
                        background: rgba(102, 126, 234, 0.2);
                        color: #a5b4fc;
                        padding: 4px 14px;
                        border-radius: 20px;
                        font-size: 13px;
                        font-weight: 500;
                    }
                    .preview-content {
                        color: #cbd5e1;
                        font-size: 15px;
                        line-height: 1.7;
                        margin-bottom: 24px;
                    }
                    .preview-content img {
                        max-width: 100%;
                        border-radius: 8px;
                        margin: 12px 0;
                    }
                    .preview-content ul, .preview-content ol {
                        padding-left: 24px;
                        margin: 12px 0;
                    }
                    .preview-content li {
                        margin-bottom: 6px;
                    }
                    .preview-content b, .preview-content strong {
                        color: #ffffff;
                    }
                    .preview-footer {
                        display: flex;
                        justify-content: center;
                    }
                    .preview-dismiss-btn {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border: none;
                        padding: 12px 48px;
                        border-radius: 10px;
                        font-size: 15px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
                    }
                    .preview-dismiss-btn:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
                    }
                </style>
                <div class="preview-modal">
                    <span class="preview-badge">é¢„è§ˆæ¨¡å¼</span>
                    <button class="preview-close" onclick="closeAnnouncementPreview()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                    <div class="preview-header">
                        <div class="preview-icon">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                                <path d="M2 17l10 5 10-5"></path>
                                <path d="M2 12l10 5 10-5"></path>
                            </svg>
                        </div>
                        <h2 class="preview-title">${escapeHtml(title)}</h2>
                        ${version ? `<span class="preview-version">ç‰ˆæœ¬ ${escapeHtml(version)}</span>` : ''}
                    </div>
                    <div class="preview-content">
                        ${message || '<p style="color:#64748b;text-align:center;">æš‚æ— å†…å®¹</p>'}
                    </div>
                    <div class="preview-footer">
                        <button class="preview-dismiss-btn" onclick="closeAnnouncementPreview()">å…³é—­</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(previewOverlay);
            
            // Close on overlay click
            previewOverlay.addEventListener('click', (e) => {
                if (e.target === previewOverlay) {
                    closeAnnouncementPreview();
                }
            });
            
            // Close on Escape
            document.addEventListener('keydown', function escHandler(e) {
                if (e.key === 'Escape') {
                    closeAnnouncementPreview();
                    document.removeEventListener('keydown', escHandler);
                }
            });
        }
        
        function closeAnnouncementPreview() {
            const overlay = document.getElementById('announcement-preview-overlay');
            if (overlay) {
                overlay.style.animation = 'fadeIn 0.2s ease reverse';
                setTimeout(() => overlay.remove(), 200);
            }
        }
        
        // Helper function
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        async function saveAnnouncementConfig() {
            const enabled = document.getElementById('announcement-enabled').checked;
            const version = document.getElementById('announcement-version').value.trim();
            const title = document.getElementById('announcement-title').value.trim();
            const message = document.getElementById('announcement-message').innerHTML.trim();
            
            // Validation only if enabled
            if (enabled) {
                if (!version) {
                    showAlert('è¯·è¾“å…¥ç‰ˆæœ¬å·', 'error');
                    return;
                }
                
                if (!title) {
                    showAlert('è¯·è¾“å…¥æ ‡é¢˜', 'error');
                    return;
                }
            }
            
            try {
                const response = await fetch('/api/admin/update-notification', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        enabled: enabled,
                        version: version,
                        title: title,
                        title_en: '',
                        message: message,
                        message_en: '',
                        show_changelog: false,
                        changelog_items: [],
                        changelog_items_en: []
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'ä¿å­˜å¤±è´¥');
                }
                
                if (enabled) {
                    showAlert('å…¬å‘Šå·²å‘å¸ƒï¼Œç”¨æˆ·ç™»å½•æ—¶å°†çœ‹åˆ°æ­¤å…¬å‘Šï¼ˆæ¯ä¸ªç‰ˆæœ¬åªæ˜¾ç¤ºä¸€æ¬¡ï¼‰', 'success');
                } else {
                    showAlert('å…¬å‘Šè®¾ç½®å·²ä¿å­˜ï¼ˆå½“å‰å·²å…³é—­ï¼‰', 'success');
                }
                loadAnnouncementConfig(); // Reload to update status
                
            } catch (error) {
                console.error('Failed to save announcement:', error);
                showAlert('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // Initialize
        loadDashboard();
    </script>
</body>
</html>

