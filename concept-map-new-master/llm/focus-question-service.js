// ç„¦ç‚¹é—®é¢˜æå–æœåŠ¡æ¨¡å—
// ä»ç”¨æˆ·è¾“å…¥çš„æ–‡æœ¬ä¸­æ™ºèƒ½æå–ç„¦ç‚¹é—®é¢˜

/**
 * ç„¦ç‚¹é—®é¢˜æå–æœåŠ¡
 * è´Ÿè´£åˆ†æç”¨æˆ·è¾“å…¥çš„æ–‡æœ¬å†…å®¹ï¼Œæ€»ç»“å‡ºä¸€ä¸ªç®€æ´æ˜ç¡®çš„ç„¦ç‚¹é—®é¢˜
 */
class FocusQuestionService {
    /**
     * æ„é€ å‡½æ•°
     * @param {string} apiBaseUrl - APIåŸºç¡€URL
     */
    constructor(apiBaseUrl) {
        this.apiBaseUrl = apiBaseUrl;
    }
    
    /**
     * ä»æ–‡æœ¬ä¸­æå–ç„¦ç‚¹é—®é¢˜
     * @param {string} text - ç”¨æˆ·è¾“å…¥çš„æ–‡æœ¬å†…å®¹
     * @returns {Promise<Object>} æå–ç»“æœ {success, focusQuestion, message}
     */
    async extractFocusQuestion(text) {
        console.log('ğŸ¯ å¼€å§‹æå–ç„¦ç‚¹é—®é¢˜ï¼Œæ–‡æœ¬é•¿åº¦:', text.length);
        console.log('   æ–‡æœ¬å†…å®¹ï¼ˆå‰100å­—ç¬¦ï¼‰:', text.substring(0, 100));
        
        try {
            // æ„å»ºæç¤ºè¯
            const prompt = this.buildFocusQuestionPrompt(text);
            console.log('   æç¤ºè¯é•¿åº¦:', prompt.length, 'å­—ç¬¦');
            
            // System Promptï¼šå®šä¹‰AIè§’è‰²å’Œè¾“å‡ºè¦æ±‚
            const systemPrompt = "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„çŸ¥è¯†åˆ†æä¸“å®¶ï¼Œæ“…é•¿ä»æ–‡æœ¬ä¸­æå–æ ¸å¿ƒä¸»é¢˜å’Œç„¦ç‚¹é—®é¢˜ã€‚è¯·ç”¨ä¸­æ–‡å›ç­”ï¼Œè¾“å‡ºå¿…é¡»ç®€æ´æ˜ç¡®ï¼Œåªè¿”å›ä¸€ä¸ªç„¦ç‚¹é—®é¢˜ï¼Œä¸è¶…è¿‡20ä¸ªå­—ã€‚";
            
            // è°ƒç”¨APIï¼ˆéæµå¼ï¼‰
            const response = await fetch(`${this.apiBaseUrl}/chat`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    message: prompt,
                    system_prompt: systemPrompt
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                // æå–ç„¦ç‚¹é—®é¢˜ï¼ˆå»é™¤å¤šä½™çš„ç¬¦å·å’Œç©ºç™½ï¼‰
                let focusQuestion = result.response.trim();
                
                // æ¸…ç†å¯èƒ½çš„æ ¼å¼é—®é¢˜
                focusQuestion = this.cleanFocusQuestion(focusQuestion);
                
                console.log('âœ… ç„¦ç‚¹é—®é¢˜æå–æˆåŠŸ:', focusQuestion);
                
                return {
                    success: true,
                    focusQuestion: focusQuestion,
                    message: 'ç„¦ç‚¹é—®é¢˜æå–æˆåŠŸ'
                };
            } else {
                console.error('âŒ AIå“åº”å¤±è´¥:', result.error);
                return {
                    success: false,
                    error: result.error || 'æœªçŸ¥é”™è¯¯',
                    message: `ç„¦ç‚¹é—®é¢˜æå–å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}`
                };
            }
            
        } catch (error) {
            console.error('ç„¦ç‚¹é—®é¢˜æå–å¤±è´¥:', error);
            return {
                success: false,
                error: error.message,
                message: 'ç„¦ç‚¹é—®é¢˜æå–å¤±è´¥'
            };
        }
    }
    
    /**
     * æ„å»ºç„¦ç‚¹é—®é¢˜æå–æç¤ºè¯
     * @param {string} text - ç”¨æˆ·è¾“å…¥çš„æ–‡æœ¬
     * @returns {string} æç¤ºè¯
     */
    buildFocusQuestionPrompt(text) {
        return `# ä»»åŠ¡ï¼šä»æ–‡æœ¬ä¸­æå–ç„¦ç‚¹é—®é¢˜

## ğŸ“‹ ç”¨æˆ·è¾“å…¥çš„æ–‡æœ¬å†…å®¹ï¼š
${text}

## ğŸ¯ ä½ çš„ä»»åŠ¡ï¼š
è¯·ä»”ç»†é˜…è¯»ä¸Šè¿°æ–‡æœ¬ï¼Œåˆ†æå…¶æ ¸å¿ƒä¸»é¢˜ï¼Œå¹¶æå–å‡ºä¸€ä¸ª**ç®€æ´æ˜ç¡®çš„ç„¦ç‚¹é—®é¢˜**ã€‚

## âš ï¸ ä¸¥æ ¼è¦æ±‚ï¼š
1. **æ ¼å¼è¦æ±‚**ï¼š
   - åªè¾“å‡ºä¸€ä¸ªç„¦ç‚¹é—®é¢˜ï¼Œä¸è¦ä»»ä½•é¢å¤–çš„è§£é‡Šæˆ–è¯´æ˜
   - ä¸è¦ä½¿ç”¨å¼•å·ã€ä¹¦åå·ç­‰åŒ…è£¹
   - ä¸è¦æ·»åŠ "ç„¦ç‚¹é—®é¢˜ï¼š"ç­‰å‰ç¼€
   - ç›´æ¥è¾“å‡ºé—®é¢˜æœ¬èº«

2. **é•¿åº¦è¦æ±‚**ï¼š
   - ç„¦ç‚¹é—®é¢˜å¿…é¡»ç®€æ´ï¼Œä¸è¶…è¿‡20ä¸ªå­—
   - é¿å…å†—é•¿çš„æè¿°

3. **å†…å®¹è¦æ±‚**ï¼š
   - å¿…é¡»æ˜¯ç–‘é—®å¥æˆ–é™ˆè¿°å¥
   - èƒ½å¤Ÿæ¦‚æ‹¬æ–‡æœ¬çš„æ ¸å¿ƒä¸»é¢˜
   - é€‚åˆä½œä¸ºæ¦‚å¿µå›¾çš„ä¸­å¿ƒé—®é¢˜
   - ä½¿ç”¨ä¸­æ–‡è¡¨è¾¾

4. **ç±»å‹é€‰æ‹©**ï¼š
   æ ¹æ®æ–‡æœ¬å†…å®¹ï¼Œé€‰æ‹©æœ€åˆé€‚çš„é—®é¢˜ç±»å‹ï¼š
   - **æ˜¯ä»€ä¹ˆ**ï¼šé€‚åˆå®šä¹‰ã€æ¦‚å¿µã€æœ¬è´¨ç±»æ–‡æœ¬
     ä¾‹å¦‚ï¼š"äººå·¥æ™ºèƒ½æ˜¯ä»€ä¹ˆ"ã€"åŒºå—é“¾çš„å®šä¹‰"
   
   - **æ€ä¹ˆæ ·**ï¼šé€‚åˆæè¿°ç‰¹ç‚¹ã€çŠ¶æ€ã€è¯„ä»·ç±»æ–‡æœ¬
     ä¾‹å¦‚ï¼š"ä¸­å›½ç»æµå‘å±•æ€ä¹ˆæ ·"ã€"æ°”å€™å˜åŒ–çš„å½±å“"
   
   - **æœ‰å“ªäº›**ï¼šé€‚åˆåˆ†ç±»ã€åˆ—ä¸¾ã€è¦ç´ ç±»æ–‡æœ¬
     ä¾‹å¦‚ï¼š"æœºå™¨å­¦ä¹ ç®—æ³•æœ‰å“ªäº›"ã€"æ–°èƒ½æºç±»å‹"
   
   - **å¦‚ä½•/æ€æ ·**ï¼šé€‚åˆæ–¹æ³•ã€è¿‡ç¨‹ã€æ­¥éª¤ç±»æ–‡æœ¬
     ä¾‹å¦‚ï¼š"å¦‚ä½•å­¦ä¹ ç¼–ç¨‹"ã€"æ€æ ·æé«˜æ•ˆç‡"
   
   - **ä¸ºä»€ä¹ˆ**ï¼šé€‚åˆåŸå› ã€åŠ¨æœºã€ç›®çš„ç±»æ–‡æœ¬
     ä¾‹å¦‚ï¼š"ä¸ºä»€ä¹ˆè¦å­¦ä¹ æ•°å­¦"ã€"æ”¹é©å¼€æ”¾çš„åŸå› "

## âœ… æ­£ç¡®ç¤ºä¾‹ï¼š

**ç¤ºä¾‹1**ï¼ˆå®šä¹‰ç±»æ–‡æœ¬ï¼‰ï¼š
æ–‡æœ¬ï¼š"äººå·¥æ™ºèƒ½æ˜¯è®¡ç®—æœºç§‘å­¦çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œè‡´åŠ›äºå¼€å‘èƒ½å¤Ÿæ‰§è¡Œé€šå¸¸éœ€è¦äººç±»æ™ºèƒ½çš„ä»»åŠ¡çš„ç³»ç»Ÿ..."
è¾“å‡ºï¼šäººå·¥æ™ºèƒ½æ˜¯ä»€ä¹ˆ

**ç¤ºä¾‹2**ï¼ˆåˆ†ç±»ç±»æ–‡æœ¬ï¼‰ï¼š
æ–‡æœ¬ï¼š"æœºå™¨å­¦ä¹ ä¸»è¦åŒ…æ‹¬ç›‘ç£å­¦ä¹ ã€æ— ç›‘ç£å­¦ä¹ å’Œå¼ºåŒ–å­¦ä¹ ä¸‰å¤§ç±»..."
è¾“å‡ºï¼šæœºå™¨å­¦ä¹ çš„ä¸»è¦ç±»å‹

**ç¤ºä¾‹3**ï¼ˆè¿‡ç¨‹ç±»æ–‡æœ¬ï¼‰ï¼š
æ–‡æœ¬ï¼š"æ·±åº¦å­¦ä¹ æ¨¡å‹çš„è®­ç»ƒéœ€è¦ç»è¿‡æ•°æ®é¢„å¤„ç†ã€æ¨¡å‹æ„å»ºã€å‚æ•°è°ƒä¼˜ç­‰æ­¥éª¤..."
è¾“å‡ºï¼šå¦‚ä½•è®­ç»ƒæ·±åº¦å­¦ä¹ æ¨¡å‹

**ç¤ºä¾‹4**ï¼ˆå†å²äº‹ä»¶ï¼‰ï¼š
æ–‡æœ¬ï¼š"è¾›äº¥é©å‘½æ˜¯1911å¹´çˆ†å‘çš„èµ„äº§é˜¶çº§æ°‘ä¸»é©å‘½ï¼Œæ—¨åœ¨æ¨ç¿»æ¸…æœå°å»ºä¸“åˆ¶ç»Ÿæ²»..."
è¾“å‡ºï¼šè¾›äº¥é©å‘½çš„èƒŒæ™¯

**ç¤ºä¾‹5**ï¼ˆç§‘å­¦ç°è±¡ï¼‰ï¼š
æ–‡æœ¬ï¼š"å…¨çƒå˜æš–å¯¼è‡´å†°å·èåŒ–ã€æµ·å¹³é¢ä¸Šå‡ã€æç«¯å¤©æ°”é¢‘å‘..."
è¾“å‡ºï¼šå…¨çƒå˜æš–çš„å½±å“

## âŒ é”™è¯¯ç¤ºä¾‹ï¼š

âŒ é”™è¯¯1ï¼ˆå¸¦å¼•å·ï¼‰ï¼š"äººå·¥æ™ºèƒ½æ˜¯ä»€ä¹ˆ"
âœ… æ­£ç¡®ï¼šäººå·¥æ™ºèƒ½æ˜¯ä»€ä¹ˆ

âŒ é”™è¯¯2ï¼ˆå¸¦å‰ç¼€ï¼‰ï¼šç„¦ç‚¹é—®é¢˜ï¼šæœºå™¨å­¦ä¹ çš„åº”ç”¨
âœ… æ­£ç¡®ï¼šæœºå™¨å­¦ä¹ çš„åº”ç”¨

âŒ é”™è¯¯3ï¼ˆè¿‡é•¿ï¼‰ï¼šäººå·¥æ™ºèƒ½æŠ€æœ¯åœ¨ç°ä»£ç¤¾ä¼šä¸­çš„åº”ç”¨åœºæ™¯å’Œå‘å±•è¶‹åŠ¿æ˜¯ä»€ä¹ˆ
âœ… æ­£ç¡®ï¼šäººå·¥æ™ºèƒ½çš„åº”ç”¨

âŒ é”™è¯¯4ï¼ˆå¤šä¸ªé—®é¢˜ï¼‰ï¼šä»€ä¹ˆæ˜¯æ·±åº¦å­¦ä¹ ï¼Ÿå®ƒæœ‰å“ªäº›åº”ç”¨ï¼Ÿ
âœ… æ­£ç¡®ï¼šæ·±åº¦å­¦ä¹ æ˜¯ä»€ä¹ˆ

âŒ é”™è¯¯5ï¼ˆè¿‡äºå®½æ³›ï¼‰ï¼šç§‘æŠ€
âœ… æ­£ç¡®ï¼šäººå·¥æ™ºèƒ½æŠ€æœ¯çš„å‘å±•

## ğŸ“ æå–æ­¥éª¤ï¼š
1. è¯†åˆ«æ–‡æœ¬çš„æ ¸å¿ƒä¸»é¢˜ï¼ˆäººç‰©ã€äº‹ä»¶ã€æ¦‚å¿µã€æŠ€æœ¯ç­‰ï¼‰
2. åˆ¤æ–­æ–‡æœ¬çš„ä¸»è¦å†…å®¹ç±»å‹ï¼ˆå®šä¹‰ã€åˆ†ç±»ã€è¿‡ç¨‹ã€åŸå› ç­‰ï¼‰
3. é€‰æ‹©åˆé€‚çš„é—®é¢˜ç±»å‹ï¼ˆæ˜¯ä»€ä¹ˆã€æœ‰å“ªäº›ã€å¦‚ä½•ã€ä¸ºä»€ä¹ˆï¼‰
4. ç»„åˆæˆç®€æ´çš„ç„¦ç‚¹é—®é¢˜ï¼ˆä¸è¶…è¿‡20å­—ï¼‰
5. å»é™¤æ‰€æœ‰å¤šä½™çš„æ ¼å¼å’Œç¬¦å·

## ğŸš€ ç°åœ¨å¼€å§‹ï¼š
è¯·æ ¹æ®ä¸Šè¿°è¦æ±‚ï¼Œä»ç»™å®šçš„æ–‡æœ¬ä¸­æå–ç„¦ç‚¹é—®é¢˜ï¼Œç›´æ¥è¾“å‡ºé—®é¢˜æœ¬èº«ï¼Œä¸è¦ä»»ä½•é¢å¤–å†…å®¹ã€‚`;
    }
    
    /**
     * æ¸…ç†ç„¦ç‚¹é—®é¢˜ï¼ˆå»é™¤å¤šä½™æ ¼å¼ï¼‰
     * @param {string} question - åŸå§‹ç„¦ç‚¹é—®é¢˜
     * @returns {string} æ¸…ç†åçš„ç„¦ç‚¹é—®é¢˜
     */
    cleanFocusQuestion(question) {
        // å»é™¤å‰åç©ºç™½
        let cleaned = question.trim();
        
        // å»é™¤å¯èƒ½çš„å‰ç¼€
        const prefixes = [
            'ç„¦ç‚¹é—®é¢˜ï¼š', 'ç„¦ç‚¹é—®é¢˜:', 'é—®é¢˜ï¼š', 'é—®é¢˜:',
            'æ ¸å¿ƒé—®é¢˜ï¼š', 'æ ¸å¿ƒé—®é¢˜:', 'ä¸­å¿ƒé—®é¢˜ï¼š', 'ä¸­å¿ƒé—®é¢˜:',
            'ä¸»é¢˜ï¼š', 'ä¸»é¢˜:', 'æ ‡é¢˜ï¼š', 'æ ‡é¢˜:'
        ];
        for (const prefix of prefixes) {
            if (cleaned.startsWith(prefix)) {
                cleaned = cleaned.substring(prefix.length).trim();
            }
        }
        
        // å»é™¤å¯èƒ½çš„å¼•å·ï¼ˆä¸­è‹±æ–‡ï¼‰
        const quotes = ['"', '"', '"', "'", "'", "ã€Œ", "ã€", "ã€", "ã€"];
        for (const quote of quotes) {
            if (cleaned.startsWith(quote)) {
                cleaned = cleaned.substring(1);
            }
            if (cleaned.endsWith(quote)) {
                cleaned = cleaned.substring(0, cleaned.length - 1);
            }
        }
        
        // å»é™¤å‰åç©ºç™½ï¼ˆå†æ¬¡æ¸…ç†ï¼‰
        cleaned = cleaned.trim();
        
        // é™åˆ¶é•¿åº¦ï¼ˆå¦‚æœè¶…è¿‡30å­—ï¼Œå°è¯•æˆªå–å‰20å­—ï¼‰
        if (cleaned.length > 30) {
            console.warn('âš ï¸ ç„¦ç‚¹é—®é¢˜è¿‡é•¿ï¼Œå°è¯•æˆªå–:', cleaned);
            cleaned = cleaned.substring(0, 20);
            
            // å¦‚æœæˆªæ–­ç‚¹ä¸åœ¨å¥å·ã€é€—å·ç­‰ï¼Œå°è¯•æ‰¾åˆ°æœ€è¿‘çš„æ–­ç‚¹
            const breakPoints = ['ã€‚', 'ï¼Œ', 'ã€', 'ï¼›', ' '];
            let lastBreak = -1;
            for (const bp of breakPoints) {
                const idx = cleaned.lastIndexOf(bp);
                if (idx > lastBreak) {
                    lastBreak = idx;
                }
            }
            if (lastBreak > 10) {
                cleaned = cleaned.substring(0, lastBreak);
            }
        }
        
        return cleaned;
    }
    
    /**
     * å¿«é€Ÿæå–ç„¦ç‚¹é—®é¢˜ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
     * @param {string} text - ç”¨æˆ·è¾“å…¥çš„æ–‡æœ¬
     * @param {number} maxRetries - æœ€å¤§é‡è¯•æ¬¡æ•°
     * @returns {Promise<Object>} æå–ç»“æœ
     */
    async extractFocusQuestionWithRetry(text, maxRetries = 2) {
        let lastError = null;
        
        for (let i = 0; i < maxRetries; i++) {
            const result = await this.extractFocusQuestion(text);
            
            if (result.success) {
                // éªŒè¯ç„¦ç‚¹é—®é¢˜çš„è´¨é‡
                if (this.validateFocusQuestion(result.focusQuestion)) {
                    return result;
                } else {
                    console.warn(`âš ï¸ ç¬¬${i + 1}æ¬¡æå–çš„ç„¦ç‚¹é—®é¢˜è´¨é‡ä¸ä½³:`, result.focusQuestion);
                    lastError = 'ç„¦ç‚¹é—®é¢˜è´¨é‡ä¸ç¬¦åˆè¦æ±‚';
                }
            } else {
                lastError = result.error;
            }
        }
        
        // æ‰€æœ‰é‡è¯•éƒ½å¤±è´¥ï¼Œè¿”å›é”™è¯¯
        return {
            success: false,
            error: lastError || 'æœªçŸ¥é”™è¯¯',
            message: 'ç„¦ç‚¹é—®é¢˜æå–å¤±è´¥ï¼Œå·²é‡è¯•' + maxRetries + 'æ¬¡'
        };
    }
    
    /**
     * éªŒè¯ç„¦ç‚¹é—®é¢˜çš„è´¨é‡
     * @param {string} question - ç„¦ç‚¹é—®é¢˜
     * @returns {boolean} æ˜¯å¦ç¬¦åˆè´¨é‡è¦æ±‚
     */
    validateFocusQuestion(question) {
        if (!question || question.length === 0) {
            return false;
        }
        
        // é•¿åº¦æ£€æŸ¥ï¼ˆ2-30å­—ç¬¦ï¼‰
        if (question.length < 2 || question.length > 30) {
            console.warn('ç„¦ç‚¹é—®é¢˜é•¿åº¦ä¸ç¬¦åˆè¦æ±‚:', question.length);
            return false;
        }
        
        // ä¸åº”è¯¥åŒ…å«å¤šä½™çš„ç¬¦å·
        const invalidPatterns = [
            /^ç„¦ç‚¹é—®é¢˜/,
            /^æ ¸å¿ƒé—®é¢˜/,
            /^é—®é¢˜ï¼š/,
            /["ã€Œã€]/,  // ä¸åº”è¯¥æœ‰å¼•å·
            /\n/,       // ä¸åº”è¯¥æœ‰æ¢è¡Œ
            /^ã€.*ã€‘/   // ä¸åº”è¯¥æœ‰ç‰¹æ®Šæ ‡è®°
        ];
        
        for (const pattern of invalidPatterns) {
            if (pattern.test(question)) {
                console.warn('ç„¦ç‚¹é—®é¢˜åŒ…å«æ— æ•ˆæ ¼å¼:', question);
                return false;
            }
        }
        
        return true;
    }
}

// å¯¼å‡ºæœåŠ¡ç±»
if (typeof module !== 'undefined' && module.exports) {
    module.exports = FocusQuestionService;
} else if (typeof window !== 'undefined') {
    window.FocusQuestionService = FocusQuestionService;
}

